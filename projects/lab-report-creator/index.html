    <!DOCTYPE html>
    <html lang="en">
        <head>
            <meta charset="UTF-8" />
            <meta
                name="viewport"
                content="width=device-width, initial-scale=1.0"
            />
            <title>Academic Report Creator - By Kholipha Al Amin</title>
            <!-- Font Awesome -->
            <link
                rel="stylesheet"
                href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
            />
            <!-- Google Fonts (Inter) -->
            <link rel="preconnect" href="https://fonts.googleapis.com" />
            <link
                rel="preconnect"
                href="https://fonts.gstatic.com"
                crossorigin
            />
            <link
                href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
                rel="stylesheet"
            />
            <!-- Marked.js -->
            <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
            <!-- jsPDF & html2canvas -->
            <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
            <style>
                :root {
                    --font-family: 'Inter', sans-serif;
                    --border-radius: 10px;
                    --shadow-sm: 0 2px 5px rgba(0, 0, 0, 0.1);
                    --shadow-md: 0 5px 15px rgba(0, 0, 0, 0.15);
                    --shadow-lg: 0 15px 35px rgba(0, 0, 0, 0.2);
                    --transition-speed: 0.3s;
                    --modal-backdrop-color: rgba(0, 0, 0, 0.6);
                }
                body:not(.theme-dark) {
                    --bg-gradient: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
                    --primary-color: #4a90e2;
                    --secondary-color: #7f8c8d;
                    --accent-color: #e91e63;
                    --text-color: #2c3e50;
                    --bg-color-main: #ffffff;
                    --bg-color-sidebar: #f8f9fa;
                    --bg-color-elements: #e9ecef;
                    --border-color: #dee2e6;
                    --heading-color: #34495e;
                    --placeholder-color: #95a5a6;
                    --shadow-color-rgb: 0, 0, 0;
                    --icon-color: var(--primary-color);
                    --btn-text-color: #ffffff;
                    --danger-color: #f44336;
                    --success-color: #4caf50;
                    --warning-color: #ff9800;
                    --info-color: #2196f3;
                    --modal-bg-color: var(--bg-color-main);
                }
                body.theme-dark {
                    --bg-gradient: linear-gradient(135deg, #232526 0%, #414345 100%);
                    --primary-color: #00bcd4;
                    --secondary-color: #546e7a;
                    --accent-color: #ff4081;
                    --text-color: #eceff1;
                    --bg-color-main: #263238;
                    --bg-color-sidebar: #1f2930;
                    --bg-color-elements: #37474f;
                    --border-color: #455a64;
                    --heading-color: #b0bec5;
                    --placeholder-color: #78909c;
                    --shadow-color-rgb: 0, 188, 212;
                    --icon-color: var(--primary-color);
                    --btn-text-color: #111;
                    --danger-color: #ef5350;
                    --success-color: #66bb6a;
                    --warning-color: #ffa726;
                    --info-color: #42a5f5;
                    --modal-bg-color: var(--bg-color-elements);
                }
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body {
                    font-family: var(--font-family);
                    background: var(--bg-gradient);
                    color: var(--text-color);
                    line-height: 1.7;
                    overflow-x: hidden;
                    transition: background var(--transition-speed) ease, color var(--transition-speed) ease;
                    min-height: 100vh;
                }
                ::-webkit-scrollbar { width: 10px; height: 10px; }
                ::-webkit-scrollbar-track { background: transparent; }
                body.theme-dark ::-webkit-scrollbar-thumb { background: #546e7a; border-radius: 5px; }
                body.theme-dark ::-webkit-scrollbar-thumb:hover { background: #607d8b; }
                body:not(.theme-dark) ::-webkit-scrollbar-thumb { background: #bdc3c7; border-radius: 5px; }
                body:not(.theme-dark) ::-webkit-scrollbar-thumb:hover { background: #95a5a6; }
                .container { max-width: 1500px; margin: 2rem auto; padding: 2rem; }
                header { text-align: center; margin-bottom: 3rem; position: relative; }
                h1 { font-size: 3rem; font-weight: 700; background: linear-gradient(90deg, var(--primary-color), var(--accent-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 0.5rem; text-shadow: 0 0 15px rgba(var(--shadow-color-rgb), 0.2); }
                .subtitle { color: var(--text-color); opacity: 0.8; font-size: 1.2rem; margin-bottom: 1rem; }
                .header-controls { position: absolute; top: 10px; right: 10px; display: flex; gap: 10px; }
                .control-btn { background: var(--bg-color-elements); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all var(--transition-speed) ease; font-size: 1.1rem; }
                .control-btn:hover { background-color: var(--primary-color); color: var(--btn-text-color); border-color: var(--primary-color); transform: scale(1.1) rotate(15deg); box-shadow: var(--shadow-md); }
                .app-layout { display: grid; grid-template-columns: 350px 1fr; gap: 2.5rem; transition: grid-template-columns var(--transition-speed) ease; }
                .app-layout.focus-mode { grid-template-columns: 0px 1fr; gap: 0; }
                .app-layout.focus-mode .sidebar { opacity: 0; visibility: hidden; transform: translateX(-100%); padding: 0; border: none; }
                @media (max-width: 1200px) { .app-layout { grid-template-columns: 300px 1fr; gap: 2rem; } }
                @media (max-width: 992px) { .app-layout { grid-template-columns: 1fr; } .sidebar { order: 2; margin-top: 2rem; } .main-content { order: 1; } .app-layout.focus-mode { grid-template-columns: 1fr; } .app-layout.focus-mode .sidebar { display: none; } }
                .sidebar, .main-content { background-color: var(--bg-color-main); border-radius: var(--border-radius); padding: 2rem 2.5rem; box-shadow: var(--shadow-lg); border: 1px solid var(--border-color); transition: all var(--transition-speed) ease; }
                .sidebar { background-color: var(--bg-color-sidebar); height: fit-content; opacity: 1; visibility: visible; transform: translateX(0); }
                .form-group { margin-bottom: 1.75rem; position: relative; }
                .form-group label { display: block; margin-bottom: 0.7rem; font-weight: 500; color: var(--primary-color); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; }
                .form-control { width: 100%; padding: 1rem 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--border-color); background-color: var(--bg-color-elements); color: var(--text-color); font-family: inherit; font-size: 1rem; transition: all var(--transition-speed) ease; }
                .form-control:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(var(--shadow-color-rgb), 0.2); background-color: var(--bg-color-main); }
                .form-control::placeholder { color: var(--placeholder-color); }
                .form-group .tooltip-icon { position: absolute; top: calc(0.7rem + 1em + 5px);  right: 12px; color: var(--secondary-color); cursor: help; opacity: 0.6; transition: opacity var(--transition-speed); }
                .form-group .tooltip-icon:hover { opacity: 1; }
                .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.75rem; background: linear-gradient(90deg, var(--primary-color), color-mix(in srgb, var(--primary-color) 80%, var(--accent-color) 20%)); color: var(--btn-text-color); border: none; padding: 1rem 2rem; border-radius: var(--border-radius); cursor: pointer; font-weight: 600; text-align: center; transition: all var(--transition-speed) ease; width: 100%; font-size: 1rem; box-shadow: var(--shadow-sm); text-transform: uppercase; letter-spacing: 0.8px; position: relative; overflow: hidden; z-index: 1;}
                .btn::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent); transition: left 0.6s ease; z-index: -1; }
                .btn:hover::before { left: 100%; }
                .btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: var(--shadow-md); filter: brightness(1.1); }
                .btn:active:not(:disabled) { transform: translateY(-1px); box-shadow: var(--shadow-sm); filter: brightness(0.95); }
                .btn:disabled { cursor: not-allowed; opacity: 0.6; filter: grayscale(50%); }
                .btn i { transition: transform var(--transition-speed) ease; }
                .btn:hover:not(:disabled) i { transform: scale(1.1); }
                .btn-secondary { background: var(--secondary-color); color: var(--text-color); }
                .btn-secondary:hover:not(:disabled) { background: color-mix(in srgb, var(--secondary-color) 85%, var(--text-color) 15%); }
                .btn-danger { background: linear-gradient(90deg, var(--danger-color), color-mix(in srgb, var(--danger-color) 80%, var(--accent-color) 20%)); color: white; }
                .btn-danger:hover:not(:disabled) { filter: brightness(1.1); }
                .btn.btn-outline { background: transparent; border: 2px solid var(--primary-color); color: var(--primary-color); }
                .btn.btn-outline:hover:not(:disabled) { background: var(--primary-color); color: var(--btn-text-color); }
                 .section-title { margin-bottom: 1.5rem; color: var(--heading-color); display: flex; align-items: center; gap: 0.75rem; font-size: 1.3rem; font-weight: 600; border-bottom: 1px solid var(--border-color); padding-bottom: 0.75rem; }
                .section-title i { font-size: 1.4rem; color: var(--icon-color); min-width: 25px; text-align: center; }
                .template-options, .sections-list-container, .export-options { margin-bottom: 2.5rem; }
                .template-card { background-color: var(--bg-color-elements); border-radius: var(--border-radius); padding: 1.2rem 1.5rem; margin-bottom: 1rem; cursor: pointer; transition: all var(--transition-speed) ease; border: 1px solid var(--border-color); position: relative; overflow: hidden; }
                .template-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); border-color: var(--primary-color); }
                .template-card.active { border-color: var(--primary-color); background-color: color-mix(in srgb, var(--primary-color) 10%, transparent); box-shadow: 0 0 15px rgba(var(--shadow-color-rgb), 0.15); }
                .template-card h4 { margin-bottom: 0.5rem; color: var(--heading-color); font-weight: 600; }
                .template-card h4 i { margin-right: 0.5rem; color: var(--icon-color); }
                .template-card p { font-size: 0.9rem; opacity: 0.8; color: var(--text-color); }
                .sections-list { list-style: none; padding: 0; margin: 0; max-height: 450px; overflow-y: auto; padding-right: 10px;  }
                .section-item { display: flex; align-items: center; justify-content: space-between; background-color: var(--bg-color-elements); padding: 0.9rem 1.2rem; margin-bottom: 0.75rem; border-radius: var(--border-radius); cursor: grab; transition: all var(--transition-speed) ease; border-left: 5px solid transparent; opacity: 1; }
                .section-item:hover { background-color: color-mix(in srgb, var(--bg-color-elements) 80%, var(--text-color) 5%); border-left-color: var(--secondary-color); }
                .section-item.active { background-color: color-mix(in srgb, var(--primary-color) 15%, transparent); border-left-color: var(--primary-color); box-shadow: inset 3px 0 10px rgba(var(--shadow-color-rgb), 0.1); }
                .section-item.dragging { opacity: 0.6; background: var(--secondary-color); transform: scale(1.02); box-shadow: var(--shadow-lg); cursor: grabbing; }
                .section-item[data-section="cover-page"] { cursor: default; }
                .section-item[draggable="false"] { cursor: default; }
                .section-item.hidden-section { opacity: 0.5; background-color: var(--secondary-color); border-left-color: var(--text-color); }
                .section-item.hidden-section .section-item-name span { text-decoration: line-through; }
                .section-item-name { display: flex; align-items: center; gap: 0.75rem; font-weight: 500; overflow: hidden; }
                .section-item-name i.fa-eye, .section-item-name i.fa-eye-slash, .section-item-name i.placeholder-icon { font-size: 0.9em; cursor: pointer; opacity: 0.7; transition: opacity var(--transition-speed); padding: 0 5px; color: var(--secondary-color); width: 20px; text-align: center; }
                .section-item-name i.placeholder-icon { opacity: 0; cursor: default; } 
                 .section-item-name i.fa-eye:hover, .section-item-name i.fa-eye-slash:hover { opacity: 1; color: var(--primary-color); }
                 .section-item.hidden-section i.fa-eye { display: none; }
                .section-item:not(.hidden-section) i.fa-eye-slash { display: none; }
                .section-item-name i.section-icon { color: var(--icon-color); width: 20px; text-align: center; transition: transform var(--transition-speed) ease; font-size: 1em;  }
                .section-item.active .section-item-name i.section-icon { transform: scale(1.1); }
                .section-item-name .section-letter { font-weight: 700; color: var(--primary-color); opacity: 0.8; min-width: 25px; font-size: 0.9em;}
                .section-item-name .section-text { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
                .section-item-name .optional-tag { font-size: 0.7rem; color: white; background-color: var(--accent-color); padding: 0.1rem 0.5rem; border-radius: 4px; margin-left: 0.5rem; opacity: 0.9; font-weight: 500;}
                .section-actions { display: flex; gap: 0.6rem; }
                .action-btn { background: none; border: none; color: var(--text-color); cursor: pointer; opacity: 0.6; transition: all var(--transition-speed) ease; font-size: 1rem; padding: 0.3rem; display: flex; align-items: center; justify-content: center;}
                .action-btn:hover { opacity: 1; color: var(--primary-color); transform: rotate(10deg) scale(1.15); }
                .action-btn.remove-section:hover { color: var(--danger-color); }
                .main-content .section-title { color: var(--heading-color); font-size: 1.6rem; display: flex; align-items: center; gap: 1rem;}
                .main-content .section-title i { font-size: 1.7rem; color: var(--icon-color); }
                .tab-container { margin-bottom: 2rem; }
                .tab-buttons { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: -1px; }
                .tab-btn { padding: 1rem 2rem; background: none; border: none; border-bottom: 3px solid transparent; color: var(--text-color); cursor: pointer; opacity: 0.7; transition: all var(--transition-speed) ease; font-weight: 600; font-size: 1rem; margin-bottom: -1px; position: relative;}
                .tab-btn::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 0; height: 3px; background-color: var(--primary-color); transition: width var(--transition-speed) ease; }
                .tab-btn:hover { opacity: 1; background-color: var(--bg-color-elements); }
                .tab-btn.active { opacity: 1; color: var(--primary-color); }
                .tab-btn.active::after { width: 100%; }
                .tab-content { display: none; padding: 2.5rem 0.5rem; border-top: 1px solid var(--border-color); margin-top: -1px; }
                .tab-content.active { display: block; animation: fadeIn 0.5s ease; }
                .toolbar { display: flex; gap: 0.6rem; margin-bottom: 1.5rem; flex-wrap: wrap; background-color: var(--bg-color-elements); padding: 1rem; border-radius: var(--border-radius); border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); }
                .toolbar-btn { background: var(--bg-color-main); border: 1px solid var(--border-color); color: var(--text-color); cursor: pointer; opacity: 0.9; transition: all var(--transition-speed) ease; padding: 0.7rem 1rem; border-radius: var(--border-radius); font-size: 0.9rem; }
                .toolbar-btn:hover { opacity: 1; background-color: var(--primary-color); border-color: var(--primary-color); color: var(--btn-text-color); transform: translateY(-2px); box-shadow: var(--shadow-sm); }
                .toolbar-btn.active { background-color: color-mix(in srgb, var(--primary-color) 85%, #000 15%); border-color: color-mix(in srgb, var(--primary-color) 70%, #000 30%); color: var(--btn-text-color); } 
                .toolbar-separator { width: 1px; background-color: var(--border-color); margin: 0.3rem 0.6rem; align-self: stretch; }
                .content-editor { border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 0; background-color: var(--bg-color-main); margin-bottom: 1.5rem; transition: border-color var(--transition-speed) ease; box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); }
                .content-editor:focus-within { border-color: var(--primary-color); }
                #editor-wysiwyg, #editor-markdown { padding: 1.5rem 2rem; min-height: 450px; outline: none; font-size: 1.05rem; color: var(--text-color); }
                #editor-wysiwyg h1, #editor-wysiwyg h2, #editor-wysiwyg h3, #editor-wysiwyg h4 { margin-top: 1.8em; margin-bottom: 0.9em; color: var(--heading-color); font-weight: 600; line-height: 1.3; }
                #editor-wysiwyg p { margin-bottom: 1.2em; }
                #editor-wysiwyg ul, #editor-wysiwyg ol { margin-left: 2.5em; margin-bottom: 1.2em; padding-left: 0; }
                 #editor-wysiwyg li { margin-bottom: 0.5em; }
                #editor-wysiwyg blockquote { border-left: 4px solid var(--border-color); padding-left: 1.5em; margin-left: 0; font-style: italic; color: var(--secondary-color); }
                #editor-wysiwyg table { width: 100%; border-collapse: collapse; margin: 1.8em 0; border: 1px solid var(--border-color); }
                #editor-wysiwyg th, #editor-wysiwyg td { border: 1px solid var(--border-color); padding: 0.85rem 1rem; text-align: left; }
                #editor-wysiwyg th { background-color: var(--bg-color-elements); font-weight: bold; }
                #editor-wysiwyg img { max-width: 90%; height: auto; border-radius: var(--border-radius); margin: 1.5em auto; display: block; box-shadow: var(--shadow-sm); }
                #editor-markdown { width: 100%; background-color: var(--bg-color-main); border: none; resize: vertical; font-family: 'Consolas', 'Courier New', monospace; line-height: 1.6; }
                .markdown-editor-area { display: flex; gap: 1rem; }
                .markdown-editor-area textarea, .markdown-preview-area { flex: 1; min-height: 450px; border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 1.5rem; background-color: var(--bg-color-main);  }
                .markdown-preview-area { background-color: var(--bg-color-elements); overflow-y: auto;  }
                .markdown-preview-area h1, .markdown-preview-area h2, .markdown-preview-area h3, .markdown-preview-area h4 { margin-top: 1.8em; margin-bottom: 0.9em; color: var(--heading-color); font-weight: 600; line-height: 1.3; }
                .markdown-preview-area p { margin-bottom: 1.2em; }
                .markdown-preview-area ul, .markdown-preview-area ol { margin-left: 2.5em; margin-bottom: 1.2em; padding-left: 0; }
                .markdown-preview-area li { margin-bottom: 0.5em; }
                .markdown-preview-area blockquote { border-left: 4px solid var(--border-color); padding-left: 1.5em; margin-left: 0; font-style: italic; color: var(--secondary-color); }
                .markdown-preview-area table { width: 100%; border-collapse: collapse; margin: 1.8em 0; border: 1px solid var(--border-color); }
                .markdown-preview-area th, .markdown-preview-area td { border: 1px solid var(--border-color); padding: 0.85rem 1rem; text-align: left; }
                .markdown-preview-area th { background-color: color-mix(in srgb, var(--bg-color-elements) 80%, var(--border-color) 20%); font-weight: bold; }
                .markdown-preview-area img { max-width: 90%; height: auto; border-radius: var(--border-radius); margin: 1.5em auto; display: block; box-shadow: var(--shadow-sm); }
                .editor-status-bar { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; font-size: 0.85rem; color: var(--secondary-color); opacity: 0.8; margin-top: -1rem;  }
                .save-status { display: inline-flex; align-items: center; gap: 0.5rem; transition: opacity 0.4s ease, color 0.4s ease; opacity: 0; min-width: 120px;  text-align: right; justify-content: flex-end; }
                .save-status.visible { opacity: 1; }
                .save-status i { margin-right: 0.3em; transition: transform 0.4s ease; }
                @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
                .save-status.saving i { animation: spin 1s linear infinite; }
                .save-status.saved { color: var(--success-color); }
                .save-status.unsaved { color: var(--warning-color); }
                .save-status.error { color: var(--danger-color); }
                .preview-modal {  position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--modal-backdrop-color); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); z-index: 1000; display: none; align-items: center; justify-content: center; overflow-y: auto; padding: 30px; animation: fadeIn 0.3s ease; }
                .preview-modal.show { display: flex; }
                .preview-content-area {  background-color: #ffffff; color: #111;  font-family: 'Times New Roman', Times, serif;  line-height: 1.5; font-size: 12pt;   width: 210mm; min-height: 297mm;  margin: 0 auto; padding: 20mm 20mm 20mm 20mm;  box-shadow: 0 0 25px rgba(0,0,0,0.3); border-radius: 3px; position: relative;  overflow-y: auto;  overflow-x: hidden; }
                .preview-content-area h1, .preview-content-area h2, .preview-content-area h3, .preview-content-area h4, .preview-content-area h5, .preview-content-area h6 { font-family: 'Times New Roman', Times, serif; font-weight: bold; color: #000; margin-top: 1cm; margin-bottom: 0.5cm; line-height: 1.3; page-break-after: avoid; page-break-inside: avoid; }
                .preview-content-area h1 { font-size: 20pt;  }
                .preview-content-area h2, .preview-content-area .report-section-title { font-size: 16pt; border-bottom: 1px solid #ccc; padding-bottom: 0.25cm; margin-bottom: 0.75cm; margin-top: 1.5cm; }
                .preview-content-area h3 { font-size: 14pt; }
                .preview-content-area h4 { font-size: 12pt; font-style: italic; }
                .preview-content-area p { margin-bottom: 0.5cm; text-align: justify;  color: #222; }
                .preview-content-area ul, .preview-content-area ol { margin-left: 1cm; margin-bottom: 0.5cm; padding-left: 0.5cm; }
                .preview-content-area li { margin-bottom: 0.2cm; }
                .preview-content-area table.report-table { width: 100%; border-collapse: collapse; margin: 1cm auto; font-size: 11pt; border: 1px solid #999; page-break-inside: avoid; }
                .preview-content-area table.report-table th, .preview-content-area table.report-table td { border: 1px solid #bbb; padding: 0.3cm 0.4cm; text-align: left; vertical-align: top; }
                .preview-content-area table.report-table th { background-color: #e8e8e8; font-weight: bold; color: #000; }
                .preview-content-area img { max-width: 80%;  height: auto; display: block; margin: 1cm auto; border: 1px solid #ddd; page-break-inside: avoid; }
                .preview-content-area .report-image-caption { font-style: italic; color: #555; margin-top: 0.3cm; margin-bottom: 0.8cm; text-align: center; font-size: 10pt; }
                .preview-content-area blockquote { border-left: 3px solid #ccc; padding-left: 1.5em; margin-left: 0; font-style: italic; color: #444; }
                .preview-content-area a { color: #0000EE; text-decoration: underline; }
                .preview-content-area .report-section { margin-bottom: 1cm; page-break-before: auto; } 
                .preview-content-area .cover-page { text-align: center;  min-height: calc(297mm - 40mm); display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; page-break-after: always; }
                .preview-content-area .institution-logo { max-width: 120px; max-height: 100px;  height: auto; margin-bottom: 2rem; position: absolute; top: 3cm; left: 50%; transform: translateX(-50%); }
                .preview-content-area .report-title { font-size: 24pt;  font-weight: bold; margin-bottom: 1rem; color: #000;  margin-top: 5cm; border-bottom: none;  }
                .preview-content-area .report-subtitle { font-size: 18pt;  margin-bottom: 3rem; color: #333; }
                .preview-content-area .author-info { margin-top: auto;  margin-bottom: 3rem; font-size: 12pt; line-height: 1.6; }
                .preview-content-area .author-name { font-weight: bold; margin-bottom: 0.5rem; font-size: 14pt; }
                .preview-content-area .submission-info { margin-top: auto; padding-bottom: 1cm; text-align: center; font-size: 11pt; color: #555; line-height: 1.6; }
                .preview-content-area .toc-title { font-size: 16pt; font-weight: bold; border-bottom: 1px solid #ccc; padding-bottom: 0.5rem; margin-bottom: 1rem; text-align: center; }
                .preview-content-area .toc-list { list-style: none; padding-left: 0; margin-left: 1cm; margin-right: 1cm; }
                .preview-content-area .toc-item { display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px dotted #eee; }
                .preview-content-area .toc-item a { text-decoration: none; color: #000; }
                .preview-content-area .toc-item a:hover { text-decoration: underline; }
                .preview-content-area .toc-item .page-num {  font-style: italic; color: #666; }
                .preview-close-btn { position: fixed;  top: 25px; right: 35px; background: rgba(50, 50, 50, 0.7); color: #fff; border: none; border-radius: 50%; width: 45px; height: 45px; font-size: 2rem; cursor: pointer; z-index: 1002; display: flex; align-items: center; justify-content: center; line-height: 1; padding-bottom: 3px; transition: background 0.3s ease; }
                .preview-close-btn:hover { background: rgba(0, 0, 0, 0.9); }
                #notification-area { position: fixed; bottom: 20px; right: 20px; z-index: 1005; display: flex; flex-direction: column; align-items: flex-end; gap: 10px; }
                .notification { background-color: var(--bg-color-main); color: var(--text-color); padding: 1rem 1.8rem; border-radius: var(--border-radius); box-shadow: var(--shadow-lg); z-index: 1001; opacity: 0; transform: translateX(100%); transition: opacity 0.4s ease, transform 0.4s ease; border-left: 6px solid var(--primary-color); display: flex; align-items: center; gap: 1rem; min-width: 300px; pointer-events: all; }
                .notification.show { opacity: 1; transform: translateX(0); }
                .notification.dismissing { opacity: 0; transform: translateX(110%); }
                .notification i { font-size: 1.4rem; }
                .notification.success { border-left-color: var(--success-color); } .notification.success i { color: var(--success-color); }
                .notification.error { border-left-color: var(--danger-color); } .notification.error i { color: var(--danger-color); }
                .notification.warning { border-left-color: var(--warning-color); } .notification.warning i { color: var(--warning-color); }
                .notification.info { border-left-color: var(--info-color); } .notification.info i { color: var(--info-color); }
                 .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); z-index: 1010; display: none; align-items: center; justify-content: center; }
                .loading-overlay.show { display: flex; animation: fadeIn 0.3s ease; }
                .loader { border: 8px solid var(--secondary-color); border-top: 8px solid var(--primary-color); border-radius: 50%; width: 70px; height: 70px; animation: spin 1.2s linear infinite; }
                @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
                @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
                 .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--modal-backdrop-color); z-index: 1003; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
                .modal-overlay.show { display: flex; animation: fadeIn 0.3s ease; }
                .modal-content { background-color: var(--modal-bg-color); padding: 2.5rem 3rem; border-radius: var(--border-radius); box-shadow: var(--shadow-lg); max-width: 500px; width: 90%; animation: zoomIn 0.3s ease; }
                .modal-title { color: var(--heading-color); margin-bottom: 1.5rem; font-size: 1.5rem; font-weight: 600; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem;}
                 .modal-buttons { margin-top: 2rem; display: flex; justify-content: flex-end; gap: 1rem; }
                 .modal-buttons .btn { width: auto; min-width: 100px; } 
                 @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
                .hidden { display: none !important; }
            </style>
        </head>
        <body>
            <div class="container">
                <header>
                    <div class="header-controls">
                        <button
                            id="theme-toggle-btn"
                            class="control-btn"
                            title="Toggle Theme"
                        >
                            <i class="fas fa-sun"></i>
                        </button>
                        <button
                            id="focus-toggle-btn"
                            class="control-btn"
                            title="Toggle Focus Mode"
                        >
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                    <h1>Academic Report Creator</h1>
                    <p class="subtitle">
                        By Kholipha Ahmmad Al-Amin
                    </p>
                </header>
                <div class="app-layout" id="app-layout">
                    <!-- Sidebar -->
                    <div class="sidebar">
                        <!-- Template Options -->
                        <div class="template-options">
                            <h3 class="section-title">
                                <i class="fas fa-scroll"></i> Report Templates
                            </h3>
                            <div
                                class="template-card"
                                data-template="lab-report"
                            >
                                <h4>
                                    <i class="fas fa-flask-vial"></i> Lab Report
                                </h4>
                                <p>
                                    Structured scientific report with standard
                                    sections.
                                </p>
                            </div>
                            <div
                                class="template-card"
                                data-template="assignment"
                            >
                                <h4>
                                    <i class="fas fa-file-pen"></i> Assignment
                                    Report
                                </h4>
                                <p>Flexible format for academic assignments.</p>
                            </div>
                            <div
                                class="template-card"
                                data-template="research-paper"
                            >
                                <h4>
                                    <i class="fas fa-book-open-reader"></i>
                                    Research Paper
                                </h4>
                                <p>
                                    Formal layout suitable for research
                                    publication.
                                </p>
                            </div>
                            <!-- Add more templates maybe? Thesis? Proposal? -->
                        </div>
                        <!-- Sections -->
                        <div class="sections-list-container">
                            <h3 class="section-title">
                                <i class="fas fa-stream"></i> Report Structure
                            </h3>
                            <div class="sections-list" id="sections-list">
                                <!-- Section items dynamically added -->
                            </div>
                        </div>
                        <button
                            class="btn btn-secondary"
                            id="add-section-btn"
                            style="margin-bottom: 2.5rem"
                        >
                            <i class="fas fa-plus-circle"></i> Add Custom
                            Section
                        </button>
                        <!-- Export Options -->
                        <div class="export-options">
                            <h3 class="section-title">
                                <i class="fas fa-cloud-download-alt"></i> Export
                                Options
                            </h3>
                            <button
                                class="btn btn-outline"
                                id="preview-btn"
                                style="margin-bottom: 1rem"
                            >
                                <i class="fas fa-eye"></i> Live Preview (A4)
                            </button>
                            <button
                                class="btn"
                                id="download-pdf-btn"
                                style="margin-bottom: 1rem"
                            >
                                <i class="fas fa-file-pdf"></i> Download PDF
                            </button>
                            <button
                                class="btn btn-secondary"
                                id="download-md-btn"
                                style="margin-bottom: 1rem"
                            >
                                <i class="fab fa-markdown"></i> Download
                                Markdown
                            </button>
                            <button
                                class="btn btn-secondary"
                                id="download-html-btn"
                                style="margin-bottom: 1rem"
                            >
                                <i class="fas fa-code"></i> Download HTML
                            </button>
                            <button
                                class="btn btn-danger"
                                id="clear-storage-btn"
                            >
                                <i class="fas fa-triangle-exclamation"></i>
                                Clear Saved Data
                            </button>
                        </div>
                    </div>
                    <!-- Main Content Area -->
                    <div class="main-content">
                        <div class="editor-container">
                            <h2 class="section-title current-section-title">
                                <i class="fas fa-edit"></i> Loading...
                            </h2>
                            <div class="tab-container">
                                <div class="tab-buttons">
                                    <button class="tab-btn" data-tab="form">
                                        <i class="fas fa-wpforms"></i> Cover
                                        Page Details
                                    </button>
                                    <button class="tab-btn" data-tab="editor">
                                        <i class="fas fa-pen-alt"></i> Section
                                        Content
                                    </button>
                                </div>
                                <!-- Form Tab (Cover Page) - Ensure tooltips are present -->
                                <div class="tab-content" id="form-tab">
                                    <div class="form-group">
                                        <label for="cover-institution-name"
                                            >Institution Name</label
                                        >
                                        <input
                                            type="text"
                                            id="cover-institution-name"
                                            class="form-control"
                                            placeholder="e.g., Quantum Dynamics University"
                                        />
                                        <i
                                            class="fas fa-info-circle tooltip-icon"
                                            title="Full name of your university or college."
                                        ></i>
                                    </div>
                                    <div class="form-group">
                                        <label for="cover-logo-url"
                                            >Institution Logo URL
                                            (Optional)</label
                                        >
                                        <input
                                            type="url"
                                            id="cover-logo-url"
                                            class="form-control"
                                            placeholder="https://example.com/logo.png"
                                        />
                                        <i
                                            class="fas fa-info-circle tooltip-icon"
                                            title="Direct link (URL) to the institution's logo image (e.g., ending in .png, .jpg). Ensure it's publicly accessible."
                                        ></i>
                                    </div>
                                    <div class="form-group">
                                        <label for="cover-report-title"
                                            >Report Title</label
                                        >
                                        <input
                                            type="text"
                                            id="cover-report-title"
                                            class="form-control"
                                            placeholder="e.g., Analysis of Quantum Entanglement"
                                        />
                                        <i
                                            class="fas fa-info-circle tooltip-icon"
                                            title="Main title of your report. Be clear and concise."
                                        ></i>
                                    </div>
                                    <div class="form-group">
                                        <label for="cover-report-subtitle"
                                            >Subtitle (Optional)</label
                                        >
                                        <input
                                            type="text"
                                            id="cover-report-subtitle"
                                            class="form-control"
                                            placeholder="e.g., A Comprehensive Study"
                                        />
                                        <i
                                            class="fas fa-info-circle tooltip-icon"
                                            title="An optional secondary title or description."
                                        ></i>
                                    </div>
                                    <div class="form-group">
                                        <label for="cover-author-name"
                                            >Student Name</label
                                        >
                                        <input
                                            type="text"
                                            id="cover-author-name"
                                            class="form-control"
                                            placeholder="e.g., Dr. Evelyn Reed"
                                        />
                                        <i
                                            class="fas fa-info-circle tooltip-icon"
                                            title="Your full name as you want it to appear."
                                        ></i>
                                    </div>
                                    <div class="form-group">
                                        <label for="cover-student-id"
                                            >Student ID</label
                                        >
                                        <input
                                            type="text"
                                            id="cover-student-id"
                                            class="form-control"
                                            placeholder="e.g., SC98765"
                                        />
                                        <i
                                            class="fas fa-info-circle tooltip-icon"
                                            title="Your unique student identification number."
                                        ></i>
                                    </div>
                                    <div class="form-group">
                                        <label for="cover-department"
                                            >Department</label
                                        >
                                        <input
                                            type="text"
                                            id="cover-department"
                                            class="form-control"
                                            placeholder="e.g., Physics"
                                        />
                                        <i
                                            class="fas fa-info-circle tooltip-icon"
                                            title="Your academic department (e.g., Physics, Computer Science)."
                                        ></i>
                                    </div>
                                    <div class="form-group">
                                        <label for="cover-semester"
                                            >Semester</label
                                        >
                                        <input
                                            type="text"
                                            id="cover-semester"
                                            class="form-control"
                                            placeholder="e.g., Fall 2024"
                                        />
                                        <i
                                            class="fas fa-info-circle tooltip-icon"
                                            title="The current academic semester (e.g., Fall 2024, Spring 2025)."
                                        ></i>
                                    </div>
                                    <div class="form-group">
                                        <label for="cover-course-name"
                                            >Course Name</label
                                        >
                                        <input
                                            type="text"
                                            id="cover-course-name"
                                            class="form-control"
                                            placeholder="e.g., Advanced Theoretical Physics"
                                        />
                                        <i
                                            class="fas fa-info-circle tooltip-icon"
                                            title="The full name of the course this report is for."
                                        ></i>
                                    </div>
                                    <div class="form-group">
                                        <label for="cover-course-code"
                                            >Course ID / Code</label
                                        >
                                        <input
                                            type="text"
                                            id="cover-course-code"
                                            class="form-control"
                                            placeholder="e.g., PHYS-701"
                                        />
                                        <i
                                            class="fas fa-info-circle tooltip-icon"
                                            title="The official course code (e.g., PHYS-701, CS101)."
                                        ></i>
                                    </div>
                                    <div class="form-group">
                                        <label for="cover-lab-section"
                                            >Lab Section (If applicable)</label
                                        >
                                        <input
                                            type="text"
                                            id="cover-lab-section"
                                            class="form-control"
                                            placeholder="e.g., Section B"
                                        />
                                        <i
                                            class="fas fa-info-circle tooltip-icon"
                                            title="Your specific lab section, if relevant (e.g., Section B, L01)."
                                        ></i>
                                    </div>
                                    <div class="form-group">
                                        <label for="cover-instructor-name"
                                            >Instructor Name</label
                                        >
                                        <input
                                            type="text"
                                            id="cover-instructor-name"
                                            class="form-control"
                                            placeholder="e.g., Prof. Alistair Finch"
                                        />
                                        <i
                                            class="fas fa-info-circle tooltip-icon"
                                            title="Full name of the course instructor or supervisor."
                                        ></i>
                                    </div>
                                    <div class="form-group">
                                        <label
                                            for="cover-instructor-designation"
                                            >Instructor Designation</label
                                        >
                                        <input
                                            type="text"
                                            id="cover-instructor-designation"
                                            class="form-control"
                                            placeholder="e.g., Professor"
                                        />
                                        <i
                                            class="fas fa-info-circle tooltip-icon"
                                            title="Instructor's title (e.g., Professor, Dr., Teaching Assistant)."
                                        ></i>
                                    </div>
                                    <div class="form-group">
                                        <label for="cover-instructor-department"
                                            >Instructor Department</label
                                        >
                                        <input
                                            type="text"
                                            id="cover-instructor-department"
                                            class="form-control"
                                            placeholder="e.g., Department of Physics"
                                        />
                                        <i
                                            class="fas fa-info-circle tooltip-icon"
                                            title="Department the instructor belongs to."
                                        ></i>
                                    </div>
                                    <div class="form-group">
                                        <label for="cover-experiment-date"
                                            >Date of Experiment (If
                                            applicable)</label
                                        >
                                        <input
                                            type="date"
                                            id="cover-experiment-date"
                                            class="form-control"
                                        />
                                        <i
                                            class="fas fa-info-circle tooltip-icon"
                                            title="Date when the experimental work was performed."
                                        ></i>
                                    </div>
                                    <div class="form-group">
                                        <label for="cover-submission-date"
                                            >Submission Date</label
                                        >
                                        <input
                                            type="date"
                                            id="cover-submission-date"
                                            class="form-control"
                                        />
                                        <i
                                            class="fas fa-info-circle tooltip-icon"
                                            title="The date you are submitting the report."
                                        ></i>
                                    </div>
                                    <div class="form-group">
                                        <label for="cover-assignment-number"
                                            >Assignment/Project Number (If
                                            applicable)</label
                                        >
                                        <input
                                            type="text"
                                            id="cover-assignment-number"
                                            class="form-control"
                                            placeholder="e.g., Project 3"
                                        />
                                        <i
                                            class="fas fa-info-circle tooltip-icon"
                                            title="Specific number or identifier for this assignment."
                                        ></i>
                                    </div>
                                </div>
                                <!-- Editor Tab (WYSIWYG and Markdown) -->
                                <div class="tab-content" id="editor-tab">
                                    <div class="toolbar" id="editor-toolbar">
                                        <button
                                            class="toolbar-btn"
                                            data-command="bold"
                                            title="Bold (Ctrl+B)"
                                        >
                                            <i class="fas fa-bold"></i>
                                        </button>
                                        <button
                                            class="toolbar-btn"
                                            data-command="italic"
                                            title="Italic (Ctrl+I)"
                                        >
                                            <i class="fas fa-italic"></i>
                                        </button>
                                        <button
                                            class="toolbar-btn"
                                            data-command="underline"
                                            title="Underline (Ctrl+U)"
                                        >
                                            <i class="fas fa-underline"></i>
                                        </button>
                                        <div class="toolbar-separator"></div>
                                        <button
                                            class="toolbar-btn"
                                            data-command="insertUnorderedList"
                                            title="Bullet List"
                                        >
                                            <i class="fas fa-list-ul"></i>
                                        </button>
                                        <button
                                            class="toolbar-btn"
                                            data-command="insertOrderedList"
                                            title="Numbered List"
                                        >
                                            <i class="fas fa-list-ol"></i>
                                        </button>
                                        <button
                                            class="toolbar-btn"
                                            data-command="indent"
                                            title="Indent"
                                        >
                                            <i class="fas fa-indent"></i>
                                        </button>
                                        <button
                                            class="toolbar-btn"
                                            data-command="outdent"
                                            title="Outdent"
                                        >
                                            <i class="fas fa-outdent"></i>
                                        </button>
                                        <div class="toolbar-separator"></div>
                                        <button
                                            class="toolbar-btn"
                                            data-command="formatBlock"
                                            data-value="H2"
                                            title="Heading 2"
                                        >
                                            H2
                                        </button>
                                        <button
                                            class="toolbar-btn"
                                            data-command="formatBlock"
                                            data-value="H3"
                                            title="Heading 3"
                                        >
                                            H3
                                        </button>
                                        <button
                                            class="toolbar-btn"
                                            data-command="formatBlock"
                                            data-value="H4"
                                            title="Heading 4"
                                        >
                                            H4
                                        </button>
                                        <button
                                            class="toolbar-btn"
                                            data-command="formatBlock"
                                            data-value="P"
                                            title="Paragraph"
                                        >
                                            P
                                        </button>
                                        <button
                                            class="toolbar-btn"
                                            data-command="formatBlock"
                                            data-value="BLOCKQUOTE"
                                            title="Blockquote"
                                        >
                                            <i class="fas fa-quote-left"></i>
                                        </button>
                                        <div class="toolbar-separator"></div>
                                        <button
                                            class="toolbar-btn"
                                            data-command="createLink"
                                            title="Insert Link"
                                        >
                                            <i class="fas fa-link"></i>
                                        </button>
                                        <button
                                            class="toolbar-btn"
                                            data-command="insertImage"
                                            title="Insert Image"
                                        >
                                            <i class="fas fa-image"></i>
                                        </button>
                                        <button
                                            class="toolbar-btn"
                                            data-command="insertTable"
                                            title="Insert Table"
                                        >
                                            <i class="fas fa-table"></i>
                                        </button>
                                        <button
                                            class="toolbar-btn"
                                            data-command="removeFormat"
                                            title="Clear Formatting"
                                        >
                                            <i class="fas fa-eraser"></i>
                                        </button>
                                        <div class="toolbar-separator"></div>
                                        <button
                                            class="toolbar-btn"
                                            id="toggle-editor-mode-btn"
                                            title="Toggle Editor Mode (Rich Text / Markdown)"
                                        >
                                            <i class="fas fa-code"></i>
                                            <span class="mode-indicator"
                                                >(Rich Text)</span
                                            >
                                        </button>
                                    </div>
                                    <div class="content-editor">
                                        <!-- WYSIWYG Editor -->
                                        <div
                                            id="editor-wysiwyg"
                                            contenteditable="true"
                                            spellcheck="true"
                                        ></div>
                                        <!-- Markdown Editor & Preview Area -->
                                        <div
                                            class="markdown-editor-area hidden"
                                            id="markdown-editor-area"
                                        >
                                            <textarea
                                                id="editor-markdown"
                                                placeholder="Enter Markdown here..."
                                                spellcheck="false"
                                            ></textarea>
                                            <div
                                                class="markdown-preview-area"
                                                id="markdown-preview-area"
                                            ></div>
                                        </div>
                                    </div>
                                    <div
                                        class="editor-status-bar"
                                        id="editor-status-bar"
                                    >
                                        <span id="word-count">Words: 0</span>
                                        <span
                                            class="save-status"
                                            id="save-status"
                                        >
                                            <!-- Icon and Text updated by JS -->
                                            <i class="fas fa-check-circle"></i>
                                            <span>Saved</span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div
                                class="form-buttons"
                                style="
                                    display: flex;
                                    align-items: center;
                                    gap: 1rem;
                                "
                            >
                                <button class="btn" id="save-section-btn">
                                    <i class="fas fa-save"></i> Save Current
                                    Section
                                </button>
                                <!-- Simplified Save Status moved to the status bar -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Preview Modal -->
            <div class="preview-modal" id="preview-modal">
                <button
                    class="preview-close-btn"
                    id="preview-close-btn"
                    title="Close Preview"
                >
                    &times;
                </button>
                <div class="preview-content-area" id="preview-content-area">
                    <!-- Dynamic preview content -->
                </div>
            </div>
            <!-- Add Section Modal -->
            <div class="modal-overlay" id="add-section-modal">
                <div class="modal-content">
                    <h3 class="modal-title">
                        <i
                            class="fas fa-plus-circle"
                            style="
                                color: var(--primary-color);
                                margin-right: 10px;
                            "
                        ></i>
                        Add Custom Section
                    </h3>
                    <div class="form-group" style="margin-top: 1.5rem">
                        <label for="new-section-name">Section Name</label>
                        <input
                            type="text"
                            id="new-section-name"
                            class="form-control"
                            placeholder="e.g., Further Analysis"
                        />
                    </div>
                    <div class="modal-buttons">
                        <button
                            class="btn btn-secondary"
                            id="cancel-add-section-btn"
                        >
                            Cancel
                        </button>
                        <button class="btn" id="confirm-add-section-btn">
                            Add Section
                        </button>
                    </div>
                </div>
            </div>
            <!-- Notification Area -->
            <div id="notification-area">
                <!-- Notifications will be appended here -->
            </div>
            <!-- Loading Overlay -->
            <div class="loading-overlay" id="loading-overlay">
                <div class="loader"></div>
            </div>
            <script>
                window.jsPDF = window.jspdf.jsPDF;
                document.addEventListener('DOMContentLoaded', function() {
                    const appLayout = document.getElementById('app-layout');
                    const themeToggleButton = document.getElementById('theme-toggle-btn');
                    const focusToggleButton = document.getElementById('focus-toggle-btn');
                    const container = document.querySelector('.container'); 
                    const templateCards = document.querySelectorAll('.template-card');
                    const sectionsListElement = document.getElementById('sections-list');
                    const addSectionBtn = document.getElementById('add-section-btn');
                    const previewModal = document.getElementById('preview-modal');
                    const previewContentArea = document.getElementById('preview-content-area');
                    const previewCloseBtn = document.getElementById('preview-close-btn');
                    const loadingOverlay = document.getElementById('loading-overlay');
                    const addSectionModal = document.getElementById('add-section-modal');
                    const newSectionNameInput = document.getElementById('new-section-name');
                    const confirmAddSectionBtn = document.getElementById('confirm-add-section-btn');
                    const cancelAddSectionBtn = document.getElementById('cancel-add-section-btn');
                    const notificationArea = document.getElementById('notification-area');
                    const currentSectionTitleElement = document.querySelector('.current-section-title');
                    const tabButtons = document.querySelectorAll('.tab-btn');
                    const tabContents = document.querySelectorAll('.tab-content');
                    const editorContainer = document.querySelector('.editor-container'); 
                    const previewBtn = document.getElementById('preview-btn');
                    const downloadPdfBtn = document.getElementById('download-pdf-btn');
                    const downloadMdBtn = document.getElementById('download-md-btn');
                    const downloadHtmlBtn = document.getElementById('download-html-btn');
                    const clearStorageBtn = document.getElementById('clear-storage-btn');
                     const editorToolbar = document.getElementById('editor-toolbar');
                    const toolbarButtons = editorToolbar.querySelectorAll('.toolbar-btn:not(#toggle-editor-mode-btn)');
                    const toggleEditorModeBtn = document.getElementById('toggle-editor-mode-btn');
                    const editorWysiwyg = document.getElementById('editor-wysiwyg');
                    const markdownEditorArea = document.getElementById('markdown-editor-area');
                    const editorMarkdown = document.getElementById('editor-markdown');
                    const markdownPreviewArea = document.getElementById('markdown-preview-area');
                    const editorStatusBar = document.getElementById('editor-status-bar');
                    const wordCountElement = document.getElementById('word-count');
                    const saveStatusElement = document.getElementById('save-status');
                    const saveStatusIcon = saveStatusElement.querySelector('i');
                    const saveStatusText = saveStatusElement.querySelector('span');
                    const saveSectionBtn = document.getElementById('save-section-btn');
                     const modeIndicatorElement = toggleEditorModeBtn.querySelector('.mode-indicator'); 
                    const coverFormElements = {
                        institutionName: document.getElementById('cover-institution-name'), logoUrl: document.getElementById('cover-logo-url'), reportTitle: document.getElementById('cover-report-title'), reportSubtitle: document.getElementById('cover-report-subtitle'), authorName: document.getElementById('cover-author-name'), studentId: document.getElementById('cover-student-id'), department: document.getElementById('cover-department'), semester: document.getElementById('cover-semester'), courseName: document.getElementById('cover-course-name'), courseCode: document.getElementById('cover-course-code'), labSection: document.getElementById('cover-lab-section'), instructorName: document.getElementById('cover-instructor-name'), instructorDesignation: document.getElementById('cover-instructor-designation'), instructorDepartment: document.getElementById('cover-instructor-department'), experimentDate: document.getElementById('cover-experiment-date'), submissionDate: document.getElementById('cover-submission-date'), assignmentNumber: document.getElementById('cover-assignment-number')
                    };
                    const LOCAL_STORAGE_KEY = 'academicReportData_ultra_v1'; 
                    const THEME_STORAGE_KEY = 'academicReportTheme_ultra_v1';
                    const DEBOUNCE_DELAY = 400; 
                    const AUTOSAVE_DELAY = 1800; 
                    const NOTIFICATION_DEFAULTS = { duration: 3000, type: 'info' }; 
                    const sectionIcons = {
                         'cover-page': 'fa-file-invoice', abstract: 'fa-feather-alt', 'table-of-contents': 'fa-list-ol',
                         introduction: 'fa-lightbulb', 'materials-methods': 'fa-flask-vial', results: 'fa-chart-pie',
                         discussion: 'fa-comments', conclusion: 'fa-flag-checkered', references: 'fa-book',
                         appendices: 'fa-paperclip', acknowledgements: 'fa-handshake', 'literature-review': 'fa-book-reader',
                         methodology: 'fa-gears', findings: 'fa-search-plus', analysis: 'fa-magnifying-glass-chart', 
                         limitations: 'fa-triangle-exclamation', 'future-work': 'fa-rocket', keywords: 'fa-tags',
                         'list-of-abbreviations': 'fa-font-case', 'ethics-statement': 'fa-scale-balanced', 'conflict-of-interest': 'fa-handshake-slash', 
                         'funding-statement': 'fa-sack-dollar', 'data-availability': 'fa-database', 'author-contributions': 'fa-users-gear', 
                         default: 'fa-file-lines' 
                    };
                     const defaultSections = { 
                          'lab-report': [ { id: 'cover-page', name: 'Cover Page', letter: 'A', icon: sectionIcons['cover-page'], optional: false, defaultContent: null }, { id: 'abstract', name: 'Abstract', letter: 'B', icon: sectionIcons.abstract, optional: false, defaultContent: `<h2>Abstract</h2> <p><strong>Purpose:</strong> Briefly state the main purpose or objectives of the experiment or study.</p><p><strong>Methods:</strong> Provide a concise overview of the key methods, materials, or procedures used.</p><p><strong>Results:</strong> Summarize the most important findings or observations.</p><p><strong>Conclusion:</strong> State the main conclusion(s) drawn from the results.</p><p><em>(Keep it concise, typically 150300 words)</em></p>` }, { id: 'table-of-contents', name: 'Table of Contents', letter: 'C', icon: sectionIcons['table-of-contents'], optional: true, defaultContent: `<h2>Table of Contents</h2><p>[toc-placeholder]</p><p><em>(This section will be auto-generated in the preview and exported documents based on the visible sections below.)</em></p>` }, { id: 'introduction', name: 'Introduction', letter: 'D', icon: sectionIcons.introduction, optional: false, defaultContent: `<h2>Introduction</h2><h3>Background Information</h3><p>Provide necessary context and background relevant to the experiment/topic. Define key terms.</p><h3>Rationale & Objectives</h3><p>Explain why the experiment/study was conducted. Clearly state the specific objectives or research questions.</p><h3>Hypothesis (if applicable)</h3><p>State the testable hypothesis.</p>` }, { id: 'materials-methods', name: 'Materials and Methods', letter: 'E', icon: sectionIcons['materials-methods'], optional: false, defaultContent: `<h2>Materials and Methods</h2><h3>Materials</h3><p>List all significant materials, chemicals (with concentrations), equipment (model numbers if relevant), and organisms used.</p><h3>Experimental Setup</h3><p>Describe or diagram the setup used for the experiment.</p><h3>Procedure</h3><p>Provide a step-by-step description of how the experiment was performed. Include details about controls, variables, and replication. Write in the past tense.</p><h3>Data Collection & Analysis</h3><p>Explain how data were collected and any statistical or analytical methods used.</p>` }, { id: 'results', name: 'Results', letter: 'F', icon: sectionIcons.results, optional: false, defaultContent: `<h2>Results</h2><h3>Data Presentation</h3><p>Present the collected data clearly using tables, graphs, figures, and descriptions. Ensure all figures and tables are numbered and have captions.</p><p>Do <strong>not</strong> interpret the results in this section, just present them.</p><h3>Key Findings</h3><p>Summarize the main trends or observations from the data presented.</p>` }, { id: 'discussion', name: 'Discussion', letter: 'G', icon: sectionIcons.discussion, optional: false, defaultContent: `<h2>Discussion</h2><h3>Interpretation of Results</h3><p>Explain what your results mean. Relate them back to the objectives and hypothesis stated in the introduction.</p><h3>Comparison with Literature</h3><p>Compare your findings with expected results or published literature. Discuss any discrepancies.</p><h3>Sources of Error</h3><p>Identify potential sources of error and discuss their likely impact on the results.</p><h3>Implications and Significance</h3><p>Discuss the broader implications or significance of your findings.</p><h3>Suggestions for Future Work</h3><p>Suggest improvements or further experiments based on your results.</p>` }, { id: 'conclusion', name: 'Conclusion', letter: 'H', icon: sectionIcons.conclusion, optional: false, defaultContent: `<h2>Conclusion</h2><h3>Summary of Findings</h3><p>Briefly summarize the main findings and conclusions of the study.</p><h3>Concluding Statement</h3><p>Provide a final concluding thought, perhaps restating the significance or answering the main research question.</p>` }, { id: 'references', name: 'References/Bibliography', letter: 'I', icon: sectionIcons.references, optional: false, defaultContent: `<h2>References</h2><p>List all sources cited in the report according to a consistent citation style (e.g., APA, MLA, Chicago, IEEE). Ensure every in-text citation has a corresponding entry here.</p><p>Example (APA 7th):</p><ul><li>Author, A. A., Author, B. B., & Author, C. C. (Year). Title of the article. <em>Journal Title</em>, Volume(Issue), page numbers. DOI or URL</li><li>Author, A. A. (Year). <em>Title of the book</em>. Publisher.</li></ul>` }, { id: 'appendices', name: 'Appendices', letter: 'J', icon: sectionIcons.appendices, optional: true, defaultContent: `<h2>Appendices</h2><p>Include supplementary materials here, such as raw data tables, detailed calculations, large figures, or code snippets that are too extensive for the main body of the report. Label each appendix (e.g., Appendix A, Appendix B).</p>` }, { id: 'acknowledgements', name: 'Acknowledgements', letter: 'K', icon: sectionIcons.acknowledgements, optional: true, defaultContent: `<h2>Acknowledgements</h2><p>Thank individuals, groups, or funding agencies who provided significant help or support for the work (e.g., technical assistance, advice, funding).</p>` } ],
                          'assignment': [ { id: 'cover-page', name: 'Cover Page/Title Page', letter: 'A', icon: sectionIcons['cover-page'], optional: false, defaultContent: null }, { id: 'abstract', name: 'Abstract/Executive Summary', letter: 'B', icon: sectionIcons.abstract, optional: true, defaultContent: `<h2>Abstract/Executive Summary</h2><p>Provide a brief overview of the entire report, including the purpose, key findings, and main conclusions or recommendations. Typically 100-250 words, depending on requirements.</p>` }, { id: 'table-of-contents', name: 'Table of Contents', letter: 'C', icon: sectionIcons['table-of-contents'], optional: true, defaultContent: `<h2>Table of Contents</h2><p>[toc-placeholder]</p><p><em>(Auto-generated based on visible sections below.)</em></p>` }, { id: 'introduction', name: 'Introduction', letter: 'D', icon: sectionIcons.introduction, optional: false, defaultContent: `<h2>Introduction</h2><h3>Background and Context</h3><p>Introduce the topic and provide relevant background information. Establish the importance or relevance of the subject.</p><h3>Purpose and Objectives</h3><p>Clearly state the purpose of the report and the specific objectives it aims to achieve.</p><h3>Scope and Structure</h3><p>Briefly outline the scope of the report and how it is structured (i.e., what each section covers).</p>` }, { id: 'literature-review', name: 'Literature Review/Background', letter: 'E', icon: sectionIcons['literature-review'], optional: true, defaultContent: `<h2>Literature Review/Background</h2><p>Review relevant existing literature, theories, or concepts related to the topic. Synthesize information from various sources and identify gaps or areas your report addresses.</p>` }, { id: 'methodology', name: 'Methodology/Approach', letter: 'F', icon: sectionIcons.methodology, optional: false, defaultContent: `<h2>Methodology/Approach</h2><p>Describe the methods used to gather information, conduct research, or develop the content of the report (e.g., surveys, interviews, case studies, analysis techniques, design process). Justify the chosen approach.</p>` }, { id: 'results', name: 'Results/Findings', letter: 'G', icon: sectionIcons.findings, optional: false, defaultContent: `<h2>Results/Findings</h2><p>Present the results of your research, analysis, or work. Use tables, charts, and descriptions as appropriate. Focus on presenting the data or findings objectively.</p>` }, { id: 'discussion', name: 'Discussion/Analysis', letter: 'H', icon: sectionIcons.analysis, optional: false, defaultContent: `<h2>Discussion/Analysis</h2><p>Interpret the findings presented in the Results section. Analyze their significance, implications, and relationship to the report's objectives. Compare with literature if applicable. Discuss strengths and weaknesses.</p>` }, { id: 'conclusion', name: 'Conclusion', letter: 'I', icon: sectionIcons.conclusion, optional: false, defaultContent: `<h2>Conclusion</h2><h3>Summary of Key Points</h3><p>Summarize the main findings and conclusions drawn from the analysis and discussion.</p><h3>Recommendations (if applicable)</h3><p>Based on the findings, provide actionable recommendations or suggestions.</p><h3>Concluding Remarks</h3><p>Offer final thoughts on the topic or suggest areas for future work.</p>` }, { id: 'limitations', name: 'Limitations', letter: 'J', icon: sectionIcons.limitations, optional: true, defaultContent: `<h2>Limitations</h2><p>Acknowledge any constraints or limitations of your work, such as limitations in scope, data, methodology, or time.</p>` }, /* { id: 'future-work', name: 'Future Work/Recommendations', letter: 'K', icon: sectionIcons['future-work'], optional: true, defaultContent: `<h2>Future Work/Recommendations</h2><p>[...]</p>` }, // Often combined with Conclusion */ { id: 'references', name: 'References/Bibliography', letter: 'L', icon: sectionIcons.references, optional: false, defaultContent: `<h2>References</h2><p>List all sources cited in the report using a consistent citation style specified by your instructor or institution.</p>` }, { id: 'appendices', name: 'Appendices', letter: 'M', icon: sectionIcons.appendices, optional: true, defaultContent: `<h2>Appendices</h2><p>Include supplementary materials, detailed data, questionnaires, or other supporting documents.</p>` } /* { id: 'acknowledgements', name: 'Acknowledgements', letter: 'N', icon: sectionIcons.acknowledgements, optional: true, defaultContent: `<h2>Acknowledgements</h2><p>[...]</p>` } // Less common in general assignments */ ],
                          'research-paper': [ { id: 'cover-page', name: 'Title Page', letter: 'A', icon: sectionIcons['cover-page'], optional: false, defaultContent: null }, { id: 'abstract', name: 'Abstract', letter: 'B', icon: sectionIcons.abstract, optional: false, defaultContent: `<h2>Abstract</h2><p><strong>Background:</strong> Provide a brief context for the research.</p><p><strong>Purpose/Objectives:</strong> State the primary objectives or research question.</p><p><strong>Methods:</strong> Briefly describe the key methodologies employed (e.g., study design, participants, data collection, analysis).</p><p><strong>Results:</strong> Summarize the main findings.</p><p><strong>Conclusions:</strong> State the principal conclusions and their implications.</p><p><em>(Typically structured and adheres to journal-specific word limits, often 200400 words)</em></p>` }, { id: 'keywords', name: 'Keywords', letter: 'C', icon: sectionIcons.keywords, optional: true, defaultContent: `<h2>Keywords</h2><p>Provide 46 keywords or short phrases that capture the main topics of the paper. These are used for indexing.</p><p><em>Example: Quantum computing, Entanglement, Algorithm performance, Decoherence</em></p>` }, { id: 'table-of-contents', name: 'Table of Contents', letter: 'D', icon: sectionIcons['table-of-contents'], optional: true, defaultContent: `<h2>Table of Contents</h2><p>[toc-placeholder]</p><p><em>(Generally included in longer papers or theses, less common in short journal articles. Auto-generated.)</em></p>` },  { id: 'introduction', name: 'Introduction', letter: 'F', icon: sectionIcons.introduction, optional: false, defaultContent: `<h2>1. Introduction</h2><p>Establish the context, background, and importance of the research problem. Clearly state the research question(s), objectives, and hypothesis (if applicable). Briefly outline the paper's structure and contribution.</p>` }, { id: 'literature-review', name: 'Literature Review / Theoretical Framework', letter: 'G', icon: sectionIcons['literature-review'], optional: false, defaultContent: `<h2>2. Literature Review / Background</h2><p>Provide a comprehensive review of existing relevant literature. Identify key theories, previous findings, and gaps in knowledge that your research addresses. Establish the theoretical framework guiding your study.</p>` }, { id: 'methodology', name: 'Methodology', letter: 'H', icon: sectionIcons.methodology, optional: false, defaultContent: `<h2>3. Methodology</h2><h3>3.1 Research Design</h3><p>[...]</p><h3>3.2 Participants/Sample</h3><p>[...]</p><h3>3.3 Data Collection Instruments/Procedure</h3><p>[...]</p><h3>3.4 Data Analysis Techniques</h3><p>[...]</p><h3>3.5 Ethical Considerations</h3><p>[...]</p><p><em>(Provide enough detail for the study to be replicated)</em></p>` }, { id: 'results', name: 'Results', letter: 'I', icon: sectionIcons.results, optional: false, defaultContent: `<h2>4. Results</h2><p>Present the findings of your research objectively, without interpretation. Use tables, figures, and statistical summaries as needed. Ensure clarity and precision in reporting data.</p>` }, { id: 'discussion', name: 'Discussion', letter: 'J', icon: sectionIcons.discussion, optional: false, defaultContent: `<h2>5. Discussion</h2><p>Interpret the results in light of the research questions and literature review. Discuss the implications and significance of the findings. Compare your results with previous studies. Acknowledge limitations and suggest directions for future research.</p>` }, { id: 'conclusion', name: 'Conclusion', letter: 'K', icon: sectionIcons.conclusion, optional: false, defaultContent: `<h2>6. Conclusion</h2><p>Summarize the main findings and their contributions. Briefly restate the significance of the research and its potential impact. Avoid introducing new information.</p>` }, { id: 'acknowledgements', name: 'Acknowledgements', letter: 'L', icon: sectionIcons.acknowledgements, optional: true, defaultContent: `<h2>Acknowledgements</h2><p>Acknowledge individuals, institutions, or funding bodies that supported the research.</p>` }, /* Author contributions etc. often separate */ { id: 'references', name: 'References', letter: 'P', icon: sectionIcons.references, optional: false, defaultContent: `<h2>References</h2><p>List all cited works using the citation style required by the target journal or institution.</p>` }, { id: 'appendices', name: 'Appendices/Supplementary Material', letter: 'Q', icon: sectionIcons.appendices, optional: true, defaultContent: `<h2>Appendices</h2><p>Include supplementary information not essential to the main text but helpful for understanding (e.g., survey instruments, detailed protocols, additional data tables).</p>` } ]
                     };
                    let reportData = null;
                    let currentTheme = 'light';
                    let debounceTimeout = null;
                    let autoSaveTimeout = null;
                     let unsavedChanges = false; 
                    let activeNotificationTimeouts = {}; 
                    const debounce = (func, delay) => {
                        let timeoutId;
                        return (...args) => {
                            clearTimeout(timeoutId);
                            timeoutId = setTimeout(() => func.apply(this, args), delay);
                        };
                    };
                    const sanitizeSectionId = (name) => name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
                    function initializeApp() {
                        loadTheme();
                        loadFromLocalStorage();
                        initializeReportData(); 
                        renderSectionsList();
                        updateTemplateSelectionUI();
                        if (reportData.activeSection && reportData.sectionOrder.includes(reportData.activeSection)) {
                            setActiveSection(reportData.activeSection);
                        } else if (reportData.sectionOrder.length > 0) {
                             setActiveSection(reportData.sectionOrder[0]);
                         } else {
                              console.warn("No sections available after initialization.");
                             editorContainer.innerHTML = '<p>Please select a template or add a section to begin.</p>';
                         }
                        setupDragAndDrop();
                        setupEventListeners();
                         updateWordCount();
                        updateSaveStatus(unsavedChanges ? 'unsaved' : 'idle');
                         console.log("App Initialized. Current State:", reportData);
                    }
                    function loadTheme() {
                        const savedTheme = localStorage.getItem(THEME_STORAGE_KEY) || 'light';
                        setTheme(savedTheme);
                    }
                    function setTheme(theme) {
                        currentTheme = theme;
                        document.body.classList.toggle('theme-dark', theme === 'dark');
                        themeToggleButton.innerHTML = `<i class="fas ${theme === 'dark' ? 'fa-moon' : 'fa-sun'}"></i>`;
                        localStorage.setItem(THEME_STORAGE_KEY, theme);
                    }
                    function toggleTheme() {
                        setTheme(currentTheme === 'light' ? 'dark' : 'light');
                    }
                    function toggleFocusMode() {
                         appLayout.classList.toggle('focus-mode');
                         const isFocus = appLayout.classList.contains('focus-mode');
                         focusToggleButton.innerHTML = `<i class="fas ${isFocus ? 'fa-compress-alt' : 'fa-expand-alt'}"></i>`; 
                         focusToggleButton.title = isFocus ? "Exit Focus Mode" : "Enter Focus Mode";
                        container.style.maxWidth = isFocus ? '100%' : '1500px'; 
                     }
                     function updateSaveStatus(status, message = '') {
                        saveStatusElement.classList.remove('visible', 'saving', 'saved', 'unsaved', 'error'); 
                        clearTimeout(saveStatusElement.fadeTimeout); 
                         let iconClass = 'fa-check-circle';
                         let textContent = 'Saved';
                         let statusClass = 'saved';
                         let makeVisible = true;
                         switch(status) {
                            case 'saving':
                                iconClass = 'fa-sync-alt';
                                textContent = 'Saving...';
                                statusClass = 'saving';
                                unsavedChanges = false; 
                                break;
                            case 'saved':
                                iconClass = 'fa-check-circle';
                                textContent = 'Saved';
                                statusClass = 'saved';
                                 unsavedChanges = false;
                                saveStatusElement.fadeTimeout = setTimeout(() => updateSaveStatus('idle'), 2500);
                                break;
                             case 'unsaved':
                                iconClass = 'fa-exclamation-circle';
                                textContent = 'Unsaved changes';
                                statusClass = 'unsaved';
                                unsavedChanges = true;
                                 break;
                            case 'error':
                                iconClass = 'fa-times-circle';
                                textContent = message || 'Save Error';
                                statusClass = 'error';
                                unsavedChanges = true; 
                                break;
                            case 'idle':
                            default:
                                 if (unsavedChanges) {
                                     return updateSaveStatus('unsaved');
                                 }
                                 iconClass = 'fa-check-circle'; 
                                 textContent = 'Saved'; 
                                 statusClass = 'idle';
                                 makeVisible = false; 
                         }
                        saveStatusIcon.className = `fas ${iconClass}`;
                        saveStatusText.textContent = textContent;
                        saveStatusElement.classList.add(statusClass);
                        if (makeVisible) {
                            saveStatusElement.classList.add('visible');
                         } else {
                             saveStatusElement.classList.remove('visible');
                         }
                    }
                     function handleContentChange() {
                        if (reportData.activeSection) { 
                            if (!unsavedChanges) { 
                                updateSaveStatus('unsaved');
                             } else {
                             }
                             updateWordCount();
                            if (reportData.editorMode === 'markdown') {
                                 debouncedUpdateMarkdownPreview();
                            }
                            clearTimeout(autoSaveTimeout);
                             autoSaveTimeout = setTimeout(autoSaveSection, AUTOSAVE_DELAY);
                         }
                     }
                     function autoSaveSection() {
                         if (unsavedChanges && reportData.activeSection) {
                             saveSectionContent(true); 
                         }
                     }
                     function saveToLocalStorage() {
                         try {
                            reportData.unsavedChanges = unsavedChanges;
                             localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(reportData));
                         } catch (e) {
                            console.error("Error saving to localStorage:", e);
                             showNotification({ message: `<i class="fas fa-exclamation-triangle"></i> Could not save report data. Local storage might be full or disabled.`, type: "error", duration: 0 }); 
                             updateSaveStatus('error', 'Storage Error');
                         }
                     }
                     function loadFromLocalStorage() {
                        const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                        const defaultState = { template: 'lab-report', sectionOrder: [], sections: {}, activeSection: null, editorMode: 'wysiwyg', unsavedChanges: false };
                        if (savedData) {
                            try {
                                const parsedData = JSON.parse(savedData);
                                if (parsedData && typeof parsedData === 'object' && parsedData.template && Array.isArray(parsedData.sectionOrder) && typeof parsedData.sections === 'object') {
                                    reportData = { ...defaultState, ...parsedData };
                                    reportData.sectionOrder = reportData.sectionOrder.filter(id => reportData.sections.hasOwnProperty(id));
                                    unsavedChanges = reportData.unsavedChanges || false; 
                                     showNotification({ message: '<i class="fas fa-database"></i> Report data loaded from previous session.', type: "info" });
                                } else {
                                    throw new Error("Loaded data has invalid structure.");
                                }
                             } catch (e) {
                                 console.error("Error loading or parsing localStorage data:", e);
                                 showNotification({ message: '<i class="fas fa-exclamation-triangle"></i> Could not load saved data (invalid format). Using default Lab Report template.', type: "warning", duration: 5000 });
                                reportData = { ...defaultState };
                                unsavedChanges = false;
                                localStorage.removeItem(LOCAL_STORAGE_KEY); 
                             }
                         } else {
                            reportData = { ...defaultState };
                            unsavedChanges = false;
                         }
                     }
                    function clearLocalStorage() {
                        if (confirm(" WARNING! \n\nAre you absolutely sure you want to erase ALL saved report data?\nThis includes all content, structure, and cover page details.\n\nThis action cannot be undone!")) {
                            localStorage.removeItem(LOCAL_STORAGE_KEY);
                             reportData = null; 
                            unsavedChanges = false; 
                            initializeApp(); 
                             showNotification({ message: '<i class="fas fa-trash-alt"></i> All saved data cleared. Application reset.', type: "success" });
                         }
                     }
                    function renderSectionsList() {
                        sectionsListElement.innerHTML = ''; 
                        const currentTemplateSections = defaultSections[reportData.template] || [];
                         reportData.sectionOrder.forEach(sectionId => {
                            const sectionData = reportData.sections[sectionId];
                            if (!sectionData) {
                                console.warn(`Section data missing for ID: ${sectionId}. Skipping render.`);
                                return; 
                            }
                            const definition = getSectionDefinition(sectionId);
                             const displayName = definition ? definition.name : (sectionData.customName || getSectionDisplayName(sectionId)); 
                            const iconClass = definition ? definition.icon : sectionIcons.default;
                            let letter = '';
                             let isOptional = true; 
                             let isRequiredTag = ''; 
                             if (definition) {
                                 letter = definition.letter ? definition.letter + '.' : '';
                                 isOptional = definition.optional ?? true; 
                                 if (!isOptional) {
                                      isRequiredTag = '<span class="optional-tag">Required</span>';
                                  }
                              } else if (sectionId.startsWith('custom-')) {
                                   isOptional = false; 
                               }
                             const isHidden = sectionData.visible === false;
                             const isCover = sectionId === 'cover-page';
                             const isActive = sectionId === reportData.activeSection;
                            const sectionItem = document.createElement('div');
                            sectionItem.className = `section-item ${isActive ? 'active' : ''} ${isHidden ? 'hidden-section' : ''}`;
                            sectionItem.setAttribute('data-section', sectionId);
                             sectionItem.setAttribute('draggable', !isCover && sectionId !== 'table-of-contents');
                             sectionItem.innerHTML = `
                                <div class="section-item-name">
                                     ${isOptional || isHidden
                                       ? `<i class="fas ${isHidden ? 'fa-eye-slash' : 'fa-eye'} visibility-toggle" title="${isHidden ? 'Show Section in Output' : 'Hide Section from Output'}"></i>`
                                       : '<i class="fas fa-fw placeholder-icon"></i>' }
                                    <span class="section-letter">${letter}</span>
                                    <i class="fas ${iconClass} section-icon"></i>
                                    <span class="section-text">${displayName}</span>
                                     ${isRequiredTag}
                                 </div>
                                <div class="section-actions">
                                    <button class="action-btn edit-section" title="Edit Section Content"><i class="fas fa-edit"></i></button>
                                     ${!isCover && sectionId !== 'table-of-contents' 
                                       ? `<button class="action-btn remove-section" title="Remove Section"><i class="fas fa-trash-alt"></i></button>`
                                       : ''
                                      }
                                 </div>
                             `;
                            sectionItem.addEventListener('click', (e) => {
                                if (!e.target.closest('.action-btn') && !e.target.closest('.visibility-toggle')) {
                                     setActiveSection(sectionId);
                                 }
                             });
                            sectionItem.querySelector('.edit-section')?.addEventListener('click', () => setActiveSection(sectionId));
                             const removeBtn = sectionItem.querySelector('.remove-section');
                            if (removeBtn) {
                                removeBtn.addEventListener('click', (e) => {
                                     e.stopPropagation(); 
                                     removeSection(sectionId);
                                });
                            }
                             const visibilityToggle = sectionItem.querySelector('.visibility-toggle');
                            if (visibilityToggle) {
                                visibilityToggle.addEventListener('click', (e) => {
                                    e.stopPropagation(); 
                                    toggleSectionVisibility(sectionId);
                                });
                             }
                             sectionsListElement.appendChild(sectionItem);
                         });
                         setupDragAndDrop();
                     }
                     function setActiveSection(sectionId) {
                         if (reportData.activeSection === sectionId) return; 
                         if (unsavedChanges && reportData.activeSection) {
                             saveSectionContent(true); 
                         }
                         reportData.activeSection = sectionId;
                        console.log("Active section set to:", sectionId);
                         renderSectionsList(); 
                         if (sectionId) {
                             loadSectionContent(sectionId);
                         } else {
                             editorContainer.innerHTML = '<p>Select a section from the sidebar to edit.</p>';
                              currentSectionTitleElement.innerHTML = `<i class="fas fa-hand-point-left"></i> No Section Selected`;
                          }
                         saveToLocalStorage(); 
                    }
                    function toggleSectionVisibility(sectionId) {
                         const sectionData = reportData.sections[sectionId];
                         if (sectionData) {
                             sectionData.visible = !(sectionData.visible ?? true); 
                             renderSectionsList(); 
                             saveToLocalStorage(); 
                             showNotification({ message: `Section "${getSectionDisplayName(sectionId)}" is now ${sectionData.visible ? 'VISIBLE' : 'HIDDEN'} in output.`, type: 'info', duration: 2000 });
                         }
                    }
                     function removeSection(sectionId) {
                         const sectionName = getSectionDisplayName(sectionId);
                         if (sectionId === 'cover-page' || sectionId === 'table-of-contents') {
                              showNotification({ message: `Cannot remove essential section: "${sectionName}"`, type: 'warning' });
                             return;
                          }
                         if (confirm(`Are you sure you want to remove the section "${sectionName}"?\nThis will delete its content permanently.`)) {
                             delete reportData.sections[sectionId];
                             reportData.sectionOrder = reportData.sectionOrder.filter(id => id !== sectionId);
                             if (reportData.activeSection === sectionId) {
                                 const previousIndex = reportData.sectionOrder.indexOf(sectionId); 
                                 const newActiveId = reportData.sectionOrder[previousIndex - 1] || (reportData.sectionOrder.length > 0 ? reportData.sectionOrder[0] : null);
                                 setActiveSection(newActiveId);
                             } else {
                                  renderSectionsList(); 
                              }
                             saveToLocalStorage(); 
                             showNotification({ message: `Section "${sectionName}" removed.`, type: 'success' });
                         }
                    }
                    function showAddSectionModal() {
                         newSectionNameInput.value = ''; 
                        addSectionModal.classList.add('show');
                        newSectionNameInput.focus(); 
                    }
                    function hideAddSectionModal() {
                         addSectionModal.classList.remove('show');
                     }
                    function handleAddSectionConfirm() {
                         const sectionName = newSectionNameInput.value.trim();
                        if (sectionName === '') {
                            showNotification({ message: "Section name cannot be empty.", type: 'warning' });
                            return;
                        }
                        const sectionId = 'custom-' + sanitizeSectionId(sectionName);
                         if (reportData.sections[sectionId]) {
                             showNotification({ message: `A section with a similar name ("${sectionName}") already exists. Please choose a unique name.`, type: 'warning' });
                             return;
                        }
                         reportData.sections[sectionId] = {
                             content: `<h2>${sectionName}</h2><p>Start writing content for the "${sectionName}" section here...</p>`,
                             visible: true, 
                             isCustom: true, 
                            customName: sectionName 
                         };
                        reportData.sectionOrder.push(sectionId);
                        hideAddSectionModal(); 
                        renderSectionsList();
                        setActiveSection(sectionId); 
                         saveToLocalStorage(); 
                         updateSaveStatus('unsaved'); 
                         showNotification({ message: `Custom section "${sectionName}" added successfully.`, type: 'success' });
                     }
                    function updateSectionsForTemplate(templateId) {
                         if (templateId === reportData.template) {
                             showNotification({ message: "This template is already active.", type: 'info', duration: 1500 });
                             return; 
                         }
                         if (!defaultSections[templateId]) {
                              showNotification({ message: `Template "${templateId}" not found.`, type: 'error' });
                             return;
                         }
                         if (reportData.sectionOrder.some(id => id.startsWith('custom-')) || reportData.template !== templateId) {
                             if (!confirm(`Changing template to "${templateId.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}"?\n\nThis will restructure the default sections.\nCustom sections will be kept, but their order might change.\n\nProceed?`)) {
                                 return; 
                             }
                         }
                         reportData.template = templateId;
                         initializeReportData();
                         renderSectionsList(); 
                         updateTemplateSelectionUI(); 
                         setActiveSection(reportData.sectionOrder.length > 0 ? reportData.sectionOrder[0] : null);
                        saveToLocalStorage(); 
                         showNotification({ message: `Template changed to "${reportData.template}". Structure updated.`, type: 'success' });
                         updateSaveStatus(unsavedChanges ? 'unsaved' : 'idle'); 
                     }
                    function updateTemplateSelectionUI() {
                        templateCards.forEach(card => {
                             card.classList.toggle('active', card.getAttribute('data-template') === reportData.template);
                        });
                    }
                    function initializeReportData() {
                         const templateId = reportData?.template || 'lab-report';
                         reportData.template = templateId; 
                         const templateSections = defaultSections[templateId];
                        if (!templateSections) {
                            console.error(`Invalid template ID during initialization: ${templateId}. Resetting.`);
                             showNotification({ message: `Error: Invalid template '${templateId}' found in saved data. Resetting to Lab Report.`, type: 'error', duration: 0 });
                            reportData.template = 'lab-report';
                             return initializeReportData(); 
                         }
                         const currentTemplateSectionIds = templateSections.map(sec => sec.id);
                         let newSectionOrder = [];
                        if (!reportData.sections) reportData.sections = {};
                         if (!reportData.sectionOrder) reportData.sectionOrder = [];
                         templateSections.forEach(secDef => {
                            newSectionOrder.push(secDef.id);
                             const existingData = reportData.sections[secDef.id];
                            if (!existingData) {
                                 if (secDef.id === 'cover-page') {
                                    reportData.sections[secDef.id] = { coverData: {}, visible: true };
                                 } else {
                                     reportData.sections[secDef.id] = {
                                         content: secDef.defaultContent || '',
                                         visible: !(secDef.optional ?? false) 
                                     };
                                 }
                             } else {
                                if (typeof existingData.visible === 'undefined') {
                                    existingData.visible = !(secDef.optional ?? false);
                                }
                                if (secDef.id === 'cover-page') {
                                     if (!existingData.coverData) existingData.coverData = {}; 
                                    delete existingData.content; 
                                } else {
                                     delete existingData.coverData; 
                                     if (typeof existingData.content === 'undefined') {
                                         existingData.content = secDef.defaultContent || '';
                                     }
                                }
                             }
                         });
                         const customSectionsToKeep = (reportData.sectionOrder || [])
                            .filter(id => id.startsWith('custom-') && !currentTemplateSectionIds.includes(id));
                         reportData.sectionOrder = [...newSectionOrder, ...customSectionsToKeep];
                         const finalOrderIds = new Set(reportData.sectionOrder);
                        Object.keys(reportData.sections).forEach(id => {
                            if (!finalOrderIds.has(id)) {
                                 delete reportData.sections[id];
                                console.log(`Cleaned up orphaned section data for ID: ${id}`);
                             }
                         });
                        if (!reportData.activeSection || !reportData.sections[reportData.activeSection]) {
                            reportData.activeSection = reportData.sectionOrder.length > 0 ? reportData.sectionOrder[0] : null;
                        }
                     }
                     function loadSectionContent(sectionId) {
                        if (!sectionId || !reportData.sections || !reportData.sections[sectionId]) {
                            console.error("loadSectionContent: Invalid sectionId or missing section data:", sectionId);
                            showNotification({ message: "Error: Could not load the selected section.", type: 'error' });
                             setActiveSection(reportData.sectionOrder.length > 0 ? reportData.sectionOrder[0] : null); 
                            return;
                        }
                         const sectionData = reportData.sections[sectionId];
                         const definition = getSectionDefinition(sectionId);
                         const displayName = sectionData.customName || (definition ? definition.name : getSectionDisplayName(sectionId));
                        const iconClass = definition ? definition.icon : (sectionData.isCustom ? sectionIcons.default : 'fa-question-circle'); 
                        const letter = definition?.letter ? definition.letter + '. ' : (sectionData.isCustom ? '* ' : '');
                         currentSectionTitleElement.innerHTML = `<i class="fas ${iconClass}"></i> ${letter}${displayName}`;
                         editorWysiwyg.innerHTML = '';
                         markdownEditorArea.classList.add('hidden');
                         editorWysiwyg.classList.remove('hidden');
                         editorMarkdown.value = '';
                         markdownPreviewArea.innerHTML = ''; 
                        editorWysiwyg.setAttribute('contenteditable', 'false');
                         editorMarkdown.setAttribute('readonly', 'true');
                         toggleEditorModeBtn.disabled = true;
                         editorStatusBar.classList.add('hidden'); 
                         if (sectionId === 'cover-page') {
                             switchTab('form'); 
                             const coverData = sectionData.coverData || {};
                             for (const key in coverFormElements) {
                                 if (coverFormElements.hasOwnProperty(key) && coverFormElements[key]) {
                                      coverFormElements[key].value = coverData[key] || '';
                                  }
                             }
                         } else { 
                             switchTab('editor'); 
                             editorWysiwyg.setAttribute('contenteditable', 'true');
                             editorMarkdown.removeAttribute('readonly');
                             toggleEditorModeBtn.disabled = false;
                             editorStatusBar.classList.remove('hidden');
                            let content = sectionData.content;
                             if (typeof content === 'undefined' || content === null) {
                                  content = definition?.defaultContent || `<p>Start writing content for the "${displayName}" section here...</p>`;
                              }
                             if (reportData.editorMode === 'wysiwyg') {
                                editorWysiwyg.innerHTML = content;
                                editorWysiwyg.classList.remove('hidden');
                                 markdownEditorArea.classList.add('hidden');
                                 toggleEditorModeBtn.innerHTML = `<i class="fas fa-code"></i> <span class="mode-indicator">(Rich Text)</span>`;
                                 updateToolbarState(); 
                             } else { 
                                 editorWysiwyg.classList.add('hidden');
                                 markdownEditorArea.classList.remove('hidden');
                                 try {
                                     editorMarkdown.value = htmlToMarkdownBasic(content); 
                                 } catch(e) {
                                     console.error("Error converting HTML to Markdown for editor:", e);
                                      editorMarkdown.value = `<!-- Error converting content -->\n${content}`; 
                                     showNotification({ message: "Could not convert section content to Markdown accurately for editing.", type: 'warning' });
                                 }
                                 updateMarkdownPreview(editorMarkdown.value); 
                                 toggleEditorModeBtn.innerHTML = `<i class="fas fa-edit"></i> <span class="mode-indicator">(Markdown)</span>`; 
                              }
                          }
                          updateWordCount(); 
                          setTimeout(() => {
                              if (sectionId === 'cover-page') {
                                  coverFormElements.reportTitle?.focus();
                             } else if (reportData.editorMode === 'wysiwyg') {
                                  editorWysiwyg.focus();
                              } else {
                                  editorMarkdown.focus();
                              }
                         }, 100);
                          updateSaveStatus(unsavedChanges ? 'unsaved' : 'idle');
                      }
                    function saveSectionContent(isAutoSave = false) {
                        const sectionId = reportData.activeSection;
                        if (!sectionId) {
                            if (!isAutoSave) showNotification({ message: '<i class="fas fa-exclamation-circle"></i> No section selected to save.', type: "warning" });
                            return;
                         }
                        if (!isAutoSave) {
                            updateSaveStatus('saving');
                        }
                        const displayName = getSectionDisplayName(sectionId); 
                        try {
                            if (sectionId === 'cover-page') {
                                 const coverData = reportData.sections[sectionId]?.coverData || {}; 
                                for (const key in coverFormElements) {
                                     if (coverFormElements.hasOwnProperty(key) && coverFormElements[key]) {
                                        coverData[key] = coverFormElements[key].value; 
                                      }
                                 }
                                 if (!reportData.sections[sectionId]) reportData.sections[sectionId] = {};
                                 reportData.sections[sectionId].coverData = coverData;
                                 delete reportData.sections[sectionId].content; 
                            } else { 
                                let contentToSave = '';
                                 if (reportData.editorMode === 'wysiwyg') {
                                    contentToSave = editorWysiwyg.innerHTML;
                                } else {
                                    try {
                                        marked.setOptions({ sanitize: false, breaks: true, gfm: true }); 
                                         contentToSave = marked.parse(editorMarkdown.value || '');
                                     } catch (e) {
                                        console.error("Markdown parsing error during save:", e);
                                        contentToSave = `<pre><code>${editorMarkdown.value.replace(/</g, "&lt;")}</code></pre>`; 
                                         throw new Error(`Markdown parsing failed for section "${displayName}". Content saved as raw text.`); 
                                    }
                                 }
                                if (!reportData.sections[sectionId]) reportData.sections[sectionId] = { visible: true }; 
                                reportData.sections[sectionId].content = contentToSave;
                                delete reportData.sections[sectionId].coverData; 
                            }
                            saveToLocalStorage(); 
                            updateSaveStatus('saved');
                             unsavedChanges = false;
                         } catch (error) {
                            console.error(`Error saving section "${sectionId}":`, error);
                            updateSaveStatus('error', `Save Failed: ${error.message || 'Unknown Error'}`);
                            showNotification({ message: `<i class="fas fa-times-circle"></i> Error saving "${displayName}". Changes might not be persisted. (${error.message || ''})`, type: 'error', duration: 0 });
                            unsavedChanges = true;
                         }
                     }
                     function toggleEditorMode() {
                        const currentSectionId = reportData.activeSection;
                        if (!currentSectionId || currentSectionId === 'cover-page') return; 
                         const targetMode = reportData.editorMode === 'wysiwyg' ? 'markdown' : 'wysiwyg';
                        let notificationMessage = '';
                         let contentToConvert = '';
                         let convertedContent = '';
                         if (reportData.editorMode === 'wysiwyg') {
                             contentToConvert = editorWysiwyg.innerHTML;
                             try {
                                convertedContent = htmlToMarkdownBasic(contentToConvert);
                                 notificationMessage = "Switched to Markdown Editor.";
                             } catch(e) {
                                 console.error("Error converting HTML -> Markdown:", e);
                                showNotification({message: "Failed to convert content to Markdown. Switching aborted.", type: 'error'});
                                 return;
                             }
                         } else { 
                             contentToConvert = editorMarkdown.value;
                             try {
                                 marked.setOptions({ sanitize: false, breaks: true, gfm: true });
                                convertedContent = marked.parse(contentToConvert || '');
                                notificationMessage = "Switched to Rich Text Editor.";
                            } catch (e) {
                                console.error("Error converting Markdown -> HTML:", e);
                                showNotification({message: "Failed to parse Markdown content. Switching aborted.", type: 'error'});
                                return;
                             }
                         }
                         reportData.editorMode = targetMode; 
                         if (targetMode === 'markdown') {
                             editorMarkdown.value = convertedContent; 
                             updateMarkdownPreview(convertedContent); 
                            editorWysiwyg.classList.add('hidden');
                             markdownEditorArea.classList.remove('hidden');
                             editorMarkdown.focus();
                            toggleEditorModeBtn.innerHTML = `<i class="fas fa-edit"></i> <span class="mode-indicator">(Markdown)</span>`;
                         } else { 
                             editorWysiwyg.innerHTML = convertedContent; 
                             markdownEditorArea.classList.add('hidden');
                             editorWysiwyg.classList.remove('hidden');
                             editorWysiwyg.focus();
                            toggleEditorModeBtn.innerHTML = `<i class="fas fa-code"></i> <span class="mode-indicator">(Rich Text)</span>`;
                            updateToolbarState(); 
                         }
                         updateWordCount();
                         saveToLocalStorage(); 
                         showNotification({ message: `<i class="fas fa-exchange-alt"></i> ${notificationMessage}`, type: "info", duration: 1500 });
                         handleContentChange(); 
                     }
                    function updateWordCount() {
                        let text = '';
                         if(reportData.activeSection === 'cover-page') {
                             wordCountElement.textContent = 'Word Count: N/A';
                            return;
                         }
                        if (reportData.editorMode === 'wysiwyg') {
                             text = editorWysiwyg.textContent || '';
                        } else {
                             text = editorMarkdown.value || '';
                         }
                        const words = text.match(/\b[\w'-]+\b/g) || []; // Matches word boundaries, includes letters, numbers, underscore, apostrophe, hyphen
                         wordCountElement.textContent = `Word Count: ${words.length}`;
                    }
                    const debouncedUpdateMarkdownPreview = debounce(() => {
                        if (reportData.editorMode === 'markdown' && !markdownEditorArea.classList.contains('hidden')) {
                            updateMarkdownPreview(editorMarkdown.value);
                        }
                     }, DEBOUNCE_DELAY / 2); 
                     function updateMarkdownPreview(markdown) {
                        try {
                            marked.setOptions({ sanitize: false, breaks: true, gfm: true }); 
                            markdownPreviewArea.innerHTML = marked.parse(markdown || ''); 
                        } catch (e) {
                            console.error("Markdown preview rendering error:", e);
                             markdownPreviewArea.innerHTML = `<p style="color:var(--danger-color); font-weight: bold;">Error rendering Markdown preview.</p><pre>${e.message}</pre>`;
                        }
                     }
                     function updateToolbarState() {
                         if (reportData.editorMode !== 'wysiwyg' || !document.queryCommandState) return;
                         toolbarButtons.forEach(button => {
                             const command = button.getAttribute('data-command');
                             if (command && command !== 'formatBlock') { 
                                 try {
                                    const isActive = document.queryCommandState(command);
                                    button.classList.toggle('active', isActive);
                                 } catch (e) {
                                 }
                              }
                         });
                     }
                      function executeCommand(command, value = null) {
                         if (reportData.editorMode !== 'wysiwyg' || reportData.activeSection === 'cover-page') {
                             showNotification({ message: "Formatting commands only work in Rich Text mode for content sections.", type: 'warning' });
                             return;
                          }
                         editorWysiwyg.focus(); 
                          try {
                               document.execCommand(command, false, value);
                          } catch (e) {
                             console.error(`Error executing command "${command}":`, e);
                             showNotification({ message: `Could not apply formatting: ${command}`, type: 'error' });
                          }
                          handleContentChange(); 
                         updateToolbarState(); 
                     }
                     function handleToolbarClick(button) {
                        const command = button.getAttribute('data-command');
                        const value = button.getAttribute('data-value') || null;
                        switch (command) {
                            case 'createLink':
                                const url = prompt('Enter the URL:', 'https://');
                                 if (url) executeCommand(command, url);
                                break;
                            case 'insertImage':
                                const imgUrl = prompt('Enter the Image URL:');
                                 if (imgUrl) executeCommand(command, imgUrl);
                                break;
                            case 'insertTable':
                                insertTable(); 
                                break;
                             default:
                                 executeCommand(command, value);
                                 break;
                         }
                     }
                    function insertTable() {
                         const tableHTML = `<table border="1" style="width: 100%; border-collapse: collapse;" class="report-table">
                                             <thead>
                                                 <tr>
                                                     <th>Header 1</th>
                                                     <th>Header 2</th>
                                                 </tr>
                                             </thead>
                                             <tbody>
                                                 <tr>
                                                     <td>Data 1.1</td>
                                                     <td>Data 1.2</td>
                                                 </tr>
                                                 <tr>
                                                     <td>Data 2.1</td>
                                                     <td>Data 2.2</td>
                                                 </tr>
                                              </tbody>
                                         </table><p><br></p>`; 
                        if (document.queryCommandSupported('insertHTML')) {
                            executeCommand('insertHTML', tableHTML);
                         } else {
                            try {
                                const tempArea = document.createElement('textarea');
                                tempArea.value = tableHTML;
                                document.body.appendChild(tempArea);
                                tempArea.select();
                                 document.execCommand('copy');
                                document.body.removeChild(tempArea);
                                executeCommand('paste');
                             } catch (e) {
                                 showNotification({message: "Failed to insert table automatically. Try pasting table HTML.", type: 'error'});
                             }
                         }
                         handleContentChange();
                     }
                     function getReportContent(format = 'html') {
                        let fullContent = '';
                        const coverData = reportData.sections['cover-page']?.coverData || {};
                         let tocContentHTML = null; 
                         const tocSectionId = reportData.sectionOrder.find(id => id === 'table-of-contents');
                         if ((format === 'html' || format === 'preview') && tocSectionId && reportData.sections[tocSectionId]?.visible !== false) {
                            tocContentHTML = generateTableOfContentsHTML();
                         }
                         if (reportData.sections['cover-page']?.visible !== false) {
                            if (format === 'markdown') {
                                fullContent += `# ${coverData.reportTitle || 'Report Title'}\n\n`;
                                if (coverData.reportSubtitle) fullContent += `## ${coverData.reportSubtitle}\n\n`;
                                fullContent += `**Author:** ${coverData.authorName || 'N/A'} (${coverData.studentId || 'N/A'})\n`;
                                fullContent += `**Course:** ${coverData.courseName || 'N/A'} (${coverData.courseCode || 'N/A'})\n`;
                                if (coverData.labSection) fullContent += `**Lab Section:** ${coverData.labSection}\n`;
                                fullContent += `**Instructor:** ${coverData.instructorDesignation || ''} ${coverData.instructorName || 'N/A'}\n`;
                                 if(coverData.instructorDepartment) fullContent += `(${coverData.instructorDepartment})\n`;
                                fullContent += `**Institution:** ${coverData.institutionName || 'N/A'}\n`;
                                if (coverData.experimentDate) fullContent += `**Experiment Date:** ${formatDateSimple(coverData.experimentDate)}\n`;
                                fullContent += `**Submission Date:** ${formatDateSimple(coverData.submissionDate)}\n\n`;
                                if (coverData.assignmentNumber) fullContent += `**Assignment:** ${coverData.assignmentNumber}\n\n`;
                                fullContent += '\\\n---\n\n'; 
                            } else if (format === 'html' || format === 'preview') {
                                 fullContent += `<div class="cover-page" style="text-align: center; padding: 2cm 0; border-bottom: 1px solid #ccc; margin-bottom: 1cm; page-break-after: always;">`;
                                 if (coverData.logoUrl) fullContent += `<img src="${coverData.logoUrl}" alt="${coverData.institutionName || 'Logo'}" style="max-width: 120px; margin-bottom: 2rem; display:block; margin-left:auto; margin-right:auto;">`;
                                 else if (coverData.institutionName) fullContent += `<p style="font-size: 14pt; font-weight: bold;">${coverData.institutionName}</p>`;
                                 fullContent += `<h1 style="font-size: 20pt; margin-top: 3cm;">${coverData.reportTitle || '[Report Title]'}</h1>
                                               ${coverData.reportSubtitle ? `<h2 style="font-size: 16pt;">${coverData.reportSubtitle}</h2>` : ''}
                                              <div style="margin-top: 4cm; margin-bottom: 3rem; font-size: 12pt;">
                                                  <p style="font-weight: bold;">${coverData.authorName || '[Author Name]'}</p>
                                                  <p>${coverData.studentId ? `ID: ${coverData.studentId}<br>` : ''}
                                                     ${coverData.department ? `Dept: ${coverData.department}<br>` : ''}
                                                     ${coverData.courseName ? `Course: ${coverData.courseName} (${coverData.courseCode || 'N/A'})<br>` : ''}
                                                     ${coverData.semester ? `Semester: ${coverData.semester}` : ''}
                                                  </p>
                                              </div>
                                              <div style="margin-top: auto; font-size: 11pt;">
                                                  <p>Submitted to: ${coverData.instructorDesignation || ''} ${coverData.instructorName || 'N/A'}<br>
                                                      ${coverData.instructorDepartment ? `${coverData.instructorDepartment}<br>` : ''}
                                                     ${coverData.submissionDate ? `Date: ${formatDateSimple(coverData.submissionDate)}` : ''}
                                                 </p>
                                             </div>
                                         </div>`;
                             }
                        }
                         reportData.sectionOrder.forEach(sectionId => {
                            if (sectionId !== 'cover-page') {
                                const sectionData = reportData.sections[sectionId];
                                 if (sectionData && sectionData.visible !== false) {
                                     const definition = getSectionDefinition(sectionId);
                                     const sectionName = definition ? definition.name : getSectionDisplayName(sectionId);
                                    let content = sectionData.content || '';
                                     if (sectionId === 'table-of-contents' && tocContentHTML && (format === 'html' || format === 'preview')) {
                                        content = tocContentHTML; 
                                    } else if (sectionId === 'table-of-contents' && format === 'markdown') {
                                         content = generateTableOfContentsMarkdown(); 
                                     }
                                     if (format === 'markdown') {
                                         fullContent += `## ${sectionName}\n\n`;
                                         try {
                                            fullContent += htmlToMarkdownBasic(content) + '\n\n';
                                         } catch(e) {
                                             console.warn(`Markdown conversion failed for section "${sectionName}" during export. Including raw HTML.`);
                                              fullContent += `<!-- Markdown conversion failed -->\n${content}\n\n`;
                                          }
                                         fullContent += '---\n\n';
                                     } else if (format === 'html' || format === 'preview') {
                                          fullContent += `<section class="report-section" id="report-section-${sectionId}">\n`;
                                        const titleInContentRegex = new RegExp(`^\\s*<h[1-6][^>]*>${sectionName.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')}<\\/h[1-6]>`, 'i');
                                         if (!titleInContentRegex.test(content.trim()) && sectionId !== 'table-of-contents') { 
                                             fullContent += `<h2 class="report-section-title">${sectionName}</h2>\n`;
                                          }
                                          fullContent += content + '\n</section>\n\n';
                                     }
                                }
                            }
                        });
                        return fullContent;
                    }
                     function downloadFile(content, filename, contentType) {
                        const blob = new Blob([content], { type: contentType });
                         const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                         document.body.appendChild(a); 
                        a.click();
                         document.body.removeChild(a);
                         URL.revokeObjectURL(url); 
                    }
                    function downloadMarkdown() {
                        showLoading(true, "Generating Markdown...");
                         try {
                            const mdContent = getReportContent('markdown');
                             const filename = generateFilename('md');
                            downloadFile(mdContent, filename, 'text/markdown;charset=utf-8');
                            showNotification({ message: '<i class="fab fa-markdown"></i> Markdown file generated.', type: 'success' });
                         } catch(e) {
                            console.error("Markdown Export Error:", e);
                             showNotification({ message: '<i class="fas fa-times-circle"></i> Failed to generate Markdown file.', type: 'error', duration: 0 });
                         } finally {
                             showLoading(false);
                         }
                    }
                    function downloadHTML() {
                        showLoading(true, "Generating HTML...");
                         try {
                            const previewHtmlStructure = generateReportPreviewHTML();
                             const coverData = reportData.sections['cover-page']?.coverData || {};
                            const title = coverData.reportTitle || 'Academic Report';
                            const basicStyles = `<style>
                                 body { font-family: sans-serif; max-width: 850px; margin: 30px auto; padding: 30px; line-height: 1.6; border: 1px solid #eee; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
                                 h1, h2, h3 { margin-top: 1.5em; margin-bottom: 0.7em; color: #333; line-height: 1.3; }
                                 h1 { font-size: 2em; text-align: center; } h2 { font-size: 1.5em; border-bottom: 1px solid #eee; padding-bottom: 0.3em;} h3 {font-size: 1.2em;}
                                 table { border-collapse: collapse; width: 100%; margin: 1em 0; border: 1px solid #ccc; }
                                 th, td { border: 1px solid #ddd; padding: 8px 12px; text-align: left; vertical-align: top; }
                                 th { background-color: #f2f2f2; font-weight: bold; }
                                 img { max-width: 90%; height: auto; display: block; margin: 1em auto; border: 1px solid #ddd; border-radius: 5px;}
                                 blockquote { border-left: 4px solid #ddd; padding-left: 1em; margin-left: 0; font-style: italic; color: #555; }
                                 ul, ol { margin-left: 1.5em; padding-left: 1em; }
                                 section { margin-bottom: 1.5em; }
                                 .cover-page { text-align: center; margin-bottom: 2em; padding-bottom: 2em; border-bottom: 1px dashed #ccc; }
                             </style>`;
                            const fullHtmlDoc = `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>${title}</title>${basicStyles}</head><body>${previewHtmlStructure}</body></html>`;
                            const filename = generateFilename('html');
                            downloadFile(fullHtmlDoc, filename, 'text/html;charset=utf-8');
                            showNotification({ message: '<i class="fas fa-code"></i> HTML file generated.', type: 'success' });
                         } catch(e) {
                            console.error("HTML Export Error:", e);
                            showNotification({ message: '<i class="fas fa-times-circle"></i> Failed to generate HTML file.', type: 'error', duration: 0 });
                         } finally {
                             showLoading(false);
                         }
                    }
                     function generateFilename(extension) {
                         const coverData = reportData.sections['cover-page']?.coverData || {};
                         const base = (coverData.reportTitle || 'Academic_Report')
                                        .replace(/[^\w\s-]/g, '') 
                                        .trim()
                                        .replace(/\s+/g, '_'); 
                         const dateStr = new Date().toISOString().split('T')[0]; 
                        return `${base || 'Report'}_${dateStr}.${extension}`;
                    }
                     function formatDateSimple(dateString) {
                        if (!dateString) return 'N/A';
                        try {
                             const date = new Date(dateString + 'T00:00:00');
                            if (isNaN(date.getTime())) return dateString; 
                             return date.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
                         } catch (e) {
                             return dateString; 
                         }
                    }
                     async function downloadPDF() {
                         showLoading(true, "Generating PDF (this may take a moment)...");
                         showNotification({ message: "<i class='fas fa-spinner fa-spin'></i> Generating PDF. Please wait...", type: "info", duration: 10000 }); 
                         const previewHTML = generateReportPreviewHTML(); 
                         const tempRenderDiv = document.createElement('div');
                         tempRenderDiv.style.position = 'absolute';
                         tempRenderDiv.style.left = '-9999px'; 
                         tempRenderDiv.style.width = '210mm'; 
                         tempRenderDiv.style.backgroundColor = '#fff'; 
                         tempRenderDiv.style.visibility = 'hidden'; 
                          const pdfStyles = `
                             .pdf-render-area {
                                 font-family: 'Times New Roman', Times, serif !important;
                                 font-size: 12pt !important; 
                                 line-height: 1.5 !important; 
                                 color: #000 !important; 
                                 background: #fff !important;
                                 padding: 20mm 18mm 18mm 18mm !important; 
                                 width: 210mm !important; 
                                 box-sizing: border-box !important; 
                                 overflow: visible !important; 
                                 height: auto !important;
                             }
                             .pdf-render-area * { font-family: 'Times New Roman', Times, serif !important; box-sizing: border-box; }
                             .pdf-render-area h1, .pdf-render-area h2, .pdf-render-area h3, .pdf-render-area h4 { font-weight: bold; color: #000; margin-top: 0.8cm; margin-bottom: 0.4cm; page-break-after: avoid; page-break-inside: avoid; }
                             .pdf-render-area h1 { font-size: 22pt; text-align: center; } 
                             .pdf-render-area h2, .pdf-render-area .report-section-title { font-size: 16pt; border-bottom: 1px solid #999; padding-bottom: 0.2cm; margin-top: 1.2cm; margin-bottom: 0.6cm;}
                             .pdf-render-area h3 { font-size: 14pt; }
                             .pdf-render-area h4 { font-size: 12pt; font-style: italic; }
                             .pdf-render-area p { margin-bottom: 0.4cm; text-align: justify;  color: #000; }
                             .pdf-render-area ul, .pdf-render-area ol { margin-left: 0.8cm; padding-left: 0.5cm; margin-bottom: 0.4cm; }
                             .pdf-render-area li { margin-bottom: 0.2cm; }
                             .pdf-render-area table.report-table { width: 100%; border-collapse: collapse; margin: 0.8cm auto; font-size: 10pt; border: 1px solid #666; page-break-inside: avoid; } 
                             .pdf-render-area table.report-table th, .pdf-render-area table.report-table td { border: 1px solid #999; padding: 0.25cm 0.35cm; vertical-align: top; }
                             .pdf-render-area table.report-table th { background-color: #e0e0e0; font-weight: bold; color: #000; }
                             .pdf-render-area img { max-width: 95%;  height: auto; display: block; margin: 0.8cm auto; border: 1px solid #ccc; page-break-inside: avoid; }
                             .pdf-render-area .report-image-caption { font-style: italic; color: #333; margin-top: 0.2cm; text-align: center; font-size: 9pt; }
                              .pdf-render-area blockquote { border-left: 3px solid #b0b0b0; padding-left: 1em; margin: 0.5cm 0 0.5cm 0; font-style: italic; color: #333; }
                              .pdf-render-area a { color: #000; text-decoration: none; } 
                              .pdf-render-area .report-section { page-break-before: auto; margin-bottom: 0; } 
                             .pdf-render-area .cover-page { display: flex; flex-direction: column; justify-content: space-between;  align-items: center; text-align: center; height: 257mm;  page-break-after: always; border: none; margin: 0; padding: 0; } 
                              .pdf-render-area .cover-page > * { margin-bottom: 1cm; } 
                             .pdf-render-area .institution-logo { max-width: 100px; max-height: 80px; height: auto; margin-top: 1cm;  }
                             .pdf-render-area .report-title { font-size: 24pt; margin-top: 2cm; } 
                             .pdf-render-area .report-subtitle { font-size: 18pt; margin-top: 0.5cm; }
                             .pdf-render-area .author-info { margin-top: 4cm; line-height: 1.5; font-size: 12pt; } 
                             .pdf-render-area .author-name { font-size: 14pt; font-weight: bold; }
                              .pdf-render-area .submission-info { margin-top: auto;  padding-bottom: 1cm; font-size: 11pt; line-height: 1.4; color: #333; }
                             .pdf-render-area .toc-title { font-size: 16pt; font-weight: bold; text-align: center; border: none; }
                              .pdf-render-area .toc-list { margin: 0.5cm 1cm; list-style: none; padding: 0; }
                              .pdf-render-area .toc-item { display: flex; justify-content: space-between; border-bottom: 1px dotted #ccc; padding: 0.2cm 0; }
                              .pdf-render-area .toc-item a { color: black; text-decoration: none; } 
                          `;
                         const styleSheet = document.createElement("style");
                         styleSheet.type = "text/css";
                         styleSheet.innerText = pdfStyles;
                         tempRenderDiv.appendChild(styleSheet);
                         tempRenderDiv.innerHTML += `<div class="pdf-render-area">${previewHTML}</div>`;
                         document.body.appendChild(tempRenderDiv);
                          await new Promise(resolve => setTimeout(resolve, 1000)); 
                         try {
                              const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
                              const pdfRenderAreaElement = tempRenderDiv.querySelector('.pdf-render-area');
                             const paddingLR = 18 * 2; 
                             const effectiveWidth = 210 - paddingLR; 
                              await pdf.html(pdfRenderAreaElement, {
                                  callback: function (doc) {
                                      const filename = generateFilename('pdf');
                                      doc.save(filename);
                                      showNotification({ message: "<i class='fas fa-check-circle'></i> PDF downloaded successfully!", type: "success" });
                                  },
                                  width: 210, 
                                  windowWidth: pdfRenderAreaElement.scrollWidth, 
                                  x: 0, 
                                  y: 0, 
                                   html2canvas: { scale: 1.5, 
                                       useCORS: true, 
                                       logging: false 
                                   },
                                   autoPaging: 'text' 
                              });
                         } catch (error) {
                              console.error("Error during jsPDF.html() generation:", error);
                             showNotification({ message: "<i class='fas fa-times-circle'></i> PDF generation failed. The content might be too complex or contain unsupported elements. Try simplifying the content or exporting to HTML/Markdown.", type: "error", duration: 0 });
                         } finally {
                             document.body.removeChild(tempRenderDiv);
                             showLoading(false);
                         }
                     }
                    function generateReportPreviewHTML() {
                         return getReportContent('preview'); 
                     }
                    function showPreview() {
                         showLoading(true, "Generating Preview...");
                        try {
                             const previewContent = generateReportPreviewHTML();
                            previewContentArea.innerHTML = previewContent;
                            previewModal.classList.add('show');
                             previewModal.scrollTop = 0; 
                             previewContentArea.scrollTop = 0; 
                             showNotification({ message: '<i class="fas fa-eye"></i> Displaying report preview.', type: 'info', duration: 2000 });
                        } catch(e) {
                            console.error("Preview Generation Error:", e);
                             showNotification({ message: "<i class='fas fa-times-circle'></i> Failed to generate preview.", type: 'error' });
                        } finally {
                            showLoading(false);
                         }
                    }
                     function hidePreview() {
                         previewModal.classList.remove('show');
                         previewContentArea.innerHTML = ''; 
                     }
                     function generateTableOfContentsHTML() {
                         let tocHtml = `<h2 class="toc-title">Table of Contents</h2><ul class="toc-list">`;
                        let itemCount = 0;
                         reportData.sectionOrder.forEach(sectionId => {
                             if (sectionId !== 'cover-page' && sectionId !== 'table-of-contents') {
                                 const sectionData = reportData.sections[sectionId];
                                if (sectionData && sectionData.visible !== false) {
                                     const definition = getSectionDefinition(sectionId);
                                    const sectionName = sectionData.customName || (definition ? definition.name : getSectionDisplayName(sectionId));
                                    tocHtml += `<li class="toc-item"><a href="#report-section-${sectionId}">${sectionName}</a></li>`;
                                    itemCount++;
                                }
                            }
                        });
                         tocHtml += `</ul>`;
                         return itemCount > 0 ? tocHtml : '<h2 class="toc-title">Table of Contents</h2><p><em>(No sections available for Table of Contents)</em></p>'; 
                     }
                     function generateTableOfContentsMarkdown() {
                        let tocMd = `## Table of Contents\n\n`;
                        let itemCount = 0;
                         reportData.sectionOrder.forEach((sectionId, index) => {
                            if (sectionId !== 'cover-page' && sectionId !== 'table-of-contents') {
                                 const sectionData = reportData.sections[sectionId];
                                 if (sectionData && sectionData.visible !== false) {
                                     const definition = getSectionDefinition(sectionId);
                                     const sectionName = sectionData.customName || (definition ? definition.name : getSectionDisplayName(sectionId));
                                    tocMd += `* ${sectionName}\n`;
                                    itemCount++;
                                 }
                            }
                        });
                        return itemCount > 0 ? tocMd : '## Table of Contents\n\n*No sections available for Table of Contents*\n';
                    }
                     function getSectionDefinition(sectionId) {
                        const currentTemplateSections = defaultSections[reportData?.template || 'lab-report'] || [];
                        return currentTemplateSections.find(sec => sec.id === sectionId);
                     }
                     function getSectionDisplayName(sectionId) {
                         const definition = getSectionDefinition(sectionId);
                         if (definition) return definition.name;
                         const sectionData = reportData.sections[sectionId];
                        if (sectionData?.customName) return sectionData.customName; 
                        if (sectionId.startsWith('custom-')) {
                             return sectionId.substring(7).replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()); 
                         }
                        return sectionId; 
                    }
                     function htmlToMarkdownBasic(html) {
                         if (!html) return '';
                        let markdown = html;
                         markdown = markdown.replace(/<h1[^>]*>(.*?)<\/h1>/gi, '\n# $1\n');
                         markdown = markdown.replace(/<h2[^>]*>(.*?)<\/h2>/gi, '\n## $1\n');
                         markdown = markdown.replace(/<h3[^>]*>(.*?)<\/h3>/gi, '\n### $1\n');
                         markdown = markdown.replace(/<h4[^>]*>(.*?)<\/h4>/gi, '\n#### $1\n');
                         markdown = markdown.replace(/<p[^>]*>(.*?)<\/p>/gi, '\n$1\n');
                        markdown = markdown.replace(/<blockquote[^>]*>(.*?)<\/blockquote>/gi, (match, content) => '\n> ' + htmlToMarkdownBasic(content).replace(/\n/g, '\n> ') + '\n'); 
                        markdown = markdown.replace(/<hr[^>]*>/gi, '\n---\n');
                        markdown = markdown.replace(/<br[^>]*>/gi, '\n');
                         markdown = markdown.replace(/<ul[^>]*>\s*/gi, ''); 
                         markdown = markdown.replace(/\s*<\/ul>/gi, '\n'); 
                         markdown = markdown.replace(/<ol[^>]*>\s*/gi, ''); 
                         markdown = markdown.replace(/\s*<\/ol>/gi, '\n'); 
                        markdown = markdown.replace(/<li[^>]*>(.*?)<\/li>/gi, (match, content) => '* ' + htmlToMarkdownBasic(content).trim() + '\n'); 
                        markdown = markdown.replace(/<table[^>]*>.*?<thead>.*?<tr>(.*?)<\/tr>.*?<\/thead>.*?<tbody>(.*?)<\/tbody>.*?<\/table>/gis, (match, headerRowHtml, bodyHtml) => {
                            let headerCells = (headerRowHtml.match(/<th[^>]*>(.*?)<\/th>/gi) || []).map(th => htmlToMarkdownBasic(th).trim());
                            let separator = headerCells.map(() => '---');
                            let bodyRows = (bodyHtml.match(/<tr[^>]*>(.*?)<\/tr>/gi) || []).map(rowHtml => {
                                return (rowHtml.match(/<td[^>]*>(.*?)<\/td>/gi) || []).map(td => htmlToMarkdownBasic(td).trim());
                             });
                            let mdTable = '\n' + headerCells.join(' | ') + '\n' + separator.join(' | ') + '\n';
                            bodyRows.forEach(row => { mdTable += row.join(' | ') + '\n'; });
                             return mdTable;
                        });
                         markdown = markdown.replace(/<strong[^>]*>(.*?)<\/strong>/gi, '**$1**');
                         markdown = markdown.replace(/<b[^>]*>(.*?)<\/b>/gi, '**$1**');
                         markdown = markdown.replace(/<em[^>]*>(.*?)<\/em>/gi, '*$1*');
                         markdown = markdown.replace(/<i[^>]*>(.*?)<\/i>/gi, '*$1*');
                        markdown = markdown.replace(/<u[^>]*>(.*?)<\/u>/gi, '$1'); 
                         markdown = markdown.replace(/<code[^>]*>(.*?)<\/code>/gi, '`$1`');
                        markdown = markdown.replace(/<a[^>]+href="([^"]+)"[^>]*>(.*?)<\/a>/gi, '[$2]($1)');
                         markdown = markdown.replace(/<img[^>]+src="([^"]+)"[^>]*alt="([^"]*)"[^>]*>/gi, '![$2]($1)');
                         markdown = markdown.replace(/<img[^>]+src="([^"]+)"[^>]*>/gi, '![]($1)'); // Image without alt
                         markdown = markdown.replace(/\n{3,}/g, '\n\n');
                        markdown = markdown.replace(/&nbsp;/g, ' ');
                        markdown = markdown.replace(/&amp;/g, '&');
                        markdown = markdown.replace(/&lt;/g, '<');
                        markdown = markdown.replace(/&gt;/g, '>');
                        markdown = markdown.replace(/&quot;/g, '"');
                        markdown = markdown.replace(/&#39;/g, "'");
                         return markdown.trim();
                    }
                     function switchTab(tabId) {
                         tabButtons.forEach(btn => {
                             btn.classList.toggle('active', btn.getAttribute('data-tab') === tabId);
                         });
                         tabContents.forEach(content => {
                             content.classList.toggle('active', content.id === `${tabId}-tab`);
                         });
                     }
                     function showLoading(show, message = 'Loading...') {
                         loadingOverlay.classList.toggle('show', show);
                    }
                    function showNotification({ message, type = NOTIFICATION_DEFAULTS.type, duration = NOTIFICATION_DEFAULTS.duration }) {
                         const notificationId = `notif-${Date.now()}-${Math.random()}`;
                         const notification = document.createElement('div');
                        notification.className = `notification ${type}`;
                        notification.id = notificationId;
                        notification.innerHTML = message; 
                         notification.setAttribute('role', 'alert');
                         notificationArea.appendChild(notification);
                         void notification.offsetWidth;
                         notification.classList.add('show');
                        notification.addEventListener('click', () => dismissNotification(notificationId));
                         if (duration && duration > 0) {
                             const timeoutId = setTimeout(() => {
                                 dismissNotification(notificationId);
                             }, duration);
                            activeNotificationTimeouts[notificationId] = timeoutId;
                         }
                    }
                    function dismissNotification(notificationId) {
                         const notification = document.getElementById(notificationId);
                         if (notification) {
                             if (activeNotificationTimeouts[notificationId]) {
                                 clearTimeout(activeNotificationTimeouts[notificationId]);
                                delete activeNotificationTimeouts[notificationId];
                             }
                            notification.classList.add('dismissing');
                            notification.classList.remove('show');
                             notification.addEventListener('transitionend', () => {
                                if (notification.parentNode === notificationArea) {
                                    notificationArea.removeChild(notification);
                                 }
                             }, { once: true });
                         }
                     }
                     let draggedItem = null;
                     function setupDragAndDrop() {
                        const list = sectionsListElement; 
                         list.addEventListener('dragstart', (e) => {
                            if (e.target.classList.contains('section-item') && e.target.draggable) {
                                draggedItem = e.target;
                                setTimeout(() => e.target.classList.add('dragging'), 0); 
                                 e.dataTransfer.effectAllowed = 'move';
                                 e.dataTransfer.setData('text/plain', e.target.getAttribute('data-section')); 
                            } else {
                                 e.preventDefault(); 
                             }
                         });
                         list.addEventListener('dragend', (e) => {
                             if (draggedItem) {
                                draggedItem.classList.remove('dragging');
                                 draggedItem = null;
                                 list.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                             }
                         });
                         list.addEventListener('dragover', (e) => {
                             e.preventDefault(); 
                             const targetItem = e.target.closest('.section-item');
                             if (targetItem && targetItem !== draggedItem && targetItem.draggable) { 
                                 e.dataTransfer.dropEffect = 'move';
                                  list.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); 
                                  targetItem.classList.add('drag-over'); 
                             } else {
                                 e.dataTransfer.dropEffect = 'none'; 
                                  list.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                              }
                         });
                         list.addEventListener('dragleave', (e) => {
                            const targetItem = e.target.closest('.section-item');
                             if (targetItem) {
                                 targetItem.classList.remove('drag-over');
                             }
                         });
                        list.addEventListener('drop', (e) => {
                            e.preventDefault();
                             list.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); 
                            const targetItem = e.target.closest('.section-item');
                             const droppedSectionId = e.dataTransfer.getData('text/plain');
                             if (targetItem && draggedItem && targetItem !== draggedItem && targetItem.draggable && droppedSectionId) {
                                 const targetSectionId = targetItem.getAttribute('data-section');
                                 const draggedIndex = reportData.sectionOrder.indexOf(droppedSectionId);
                                 const targetIndex = reportData.sectionOrder.indexOf(targetSectionId);
                                 if (draggedIndex > -1 && targetIndex > -1) {
                                    reportData.sectionOrder.splice(draggedIndex, 1);
                                     const newTargetIndex = (draggedIndex < targetIndex) ? targetIndex -1 : targetIndex;
                                    reportData.sectionOrder.splice(newTargetIndex, 0, droppedSectionId);
                                     renderSectionsList(); 
                                    saveToLocalStorage(); 
                                     showNotification({ message: "Section order updated.", type: 'info', duration: 1500 });
                                     updateSaveStatus('unsaved'); 
                                 } else {
                                      console.warn("Drag/Drop failed: Could not find indices for", droppedSectionId, targetSectionId);
                                  }
                            }
                         });
                     }
                    function setupEventListeners() {
                         themeToggleButton.addEventListener('click', toggleTheme);
                         focusToggleButton.addEventListener('click', toggleFocusMode);
                         templateCards.forEach(card => {
                            card.addEventListener('click', function() {
                                 updateSectionsForTemplate(this.getAttribute('data-template'));
                             });
                         });
                        addSectionBtn.addEventListener('click', showAddSectionModal);
                        confirmAddSectionBtn.addEventListener('click', handleAddSectionConfirm);
                         cancelAddSectionBtn.addEventListener('click', hideAddSectionModal);
                        addSectionModal.addEventListener('click', (e) => { 
                             if (e.target === addSectionModal) hideAddSectionModal();
                         });
                         previewBtn.addEventListener('click', showPreview);
                        downloadPdfBtn.addEventListener('click', downloadPDF);
                         downloadMdBtn.addEventListener('click', downloadMarkdown);
                         downloadHtmlBtn.addEventListener('click', downloadHTML);
                         clearStorageBtn.addEventListener('click', clearLocalStorage);
                         tabButtons.forEach(tab => {
                            tab.addEventListener('click', function() {
                                 if (unsavedChanges) autoSaveSection();
                                switchTab(this.getAttribute('data-tab'));
                            });
                         });
                         const debouncedChangeHandler = debounce(handleContentChange, DEBOUNCE_DELAY);
                        editorWysiwyg.addEventListener('input', debouncedChangeHandler);
                         editorMarkdown.addEventListener('input', debouncedChangeHandler);
                         Object.values(coverFormElements).forEach(input => {
                             if (input) input.addEventListener('input', debouncedChangeHandler);
                         });
                         toolbarButtons.forEach(button => {
                            button.addEventListener('click', () => handleToolbarClick(button));
                         });
                        toggleEditorModeBtn.addEventListener('click', toggleEditorMode);
                         editorWysiwyg.addEventListener('keyup', updateToolbarState); 
                         editorWysiwyg.addEventListener('mouseup', updateToolbarState); 
                        editorWysiwyg.addEventListener('focus', updateToolbarState); 
                         saveSectionBtn.addEventListener('click', () => saveSectionContent(false)); 
                         previewCloseBtn.addEventListener('click', hidePreview);
                         previewModal.addEventListener('click', (e) => {
                             if (e.target === previewModal) hidePreview(); 
                         });
                        document.addEventListener('keydown', (e) => { 
                             if (e.key === 'Escape' && previewModal.classList.contains('show')) {
                                 hidePreview();
                            }
                            if(e.key === 'Escape' && addSectionModal.classList.contains('show')) {
                                 hideAddSectionModal();
                            }
                             if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                                e.preventDefault(); 
                                 saveSectionContent(false); 
                                 showNotification({message: '<i class="fas fa-save"></i> Report Saved (Ctrl+S)', type: 'info', duration: 1000 });
                             }
                         });
                         window.addEventListener('beforeunload', (event) => {
                             if (unsavedChanges) {
                                 saveToLocalStorage();
                                 const confirmationMessage = 'You have unsaved changes. Are you sure you want to leave?';
                                event.returnValue = confirmationMessage; 
                                return confirmationMessage; 
                            }
                         });
                     }
                    initializeApp();
                }); 
            </script>
        </body>
    </html>